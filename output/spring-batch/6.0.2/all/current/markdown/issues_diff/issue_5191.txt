Issue #5191: Jackson2ExecutionContextStringSerializer fails to serialize job parameters with JobStep
Reference: PR #5193 (2025-12-31T03:21:14Z)
URL: https://github.com/spring-projects/spring-batch/pull/5193

--- Diff ---
diff --git a/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializer.java b/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializer.java
index 15c63218bb..4ee31f8fe8 100644
--- a/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializer.java
+++ b/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializer.java
@@ -106,6 +106,7 @@
  *
  * @author Marten Deinum
  * @author Mahmoud Ben Hassine
+ * @author Yanming Zhou
  * @since 3.0.7
  * @see ExecutionContextSerializer
  * @deprecated Since 6.0 in favor of {@link JacksonExecutionContextStringSerializer}.
@@ -210,12 +211,16 @@ public void serializeWithType(JobParameter value, JsonGenerator gen, SerializerP
 			@Override
 			public void serialize(JobParameter jobParameter, JsonGenerator jsonGenerator,
 					SerializerProvider serializerProvider) throws IOException {
+				jsonGenerator.writeStartObject();
+				jsonGenerator.writeFieldName(NAME_KEY_NAME);
+				jsonGenerator.writeObject(jobParameter.name());
 				jsonGenerator.writeFieldName(VALUE_KEY_NAME);
 				jsonGenerator.writeObject(jobParameter.value());
 				jsonGenerator.writeFieldName(TYPE_KEY_NAME);
 				jsonGenerator.writeString(jobParameter.type().getName());
 				jsonGenerator.writeFieldName(IDENTIFYING_KEY_NAME);
-				jsonGenerator.writeObject(jobParameter.identifying());
+				jsonGenerator.writeBoolean(jobParameter.identifying());
+				jsonGenerator.writeEndObject();
 			}
 
 		}
diff --git a/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializer.java b/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializer.java
index 00f47f54ac..487acedb7c 100644
--- a/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializer.java
+++ b/spring-batch-core/src/main/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializer.java
@@ -21,6 +21,9 @@
 import java.util.HashMap;
 import java.util.Map;
 
+import com.fasterxml.jackson.annotation.JsonIgnore;
+import org.springframework.batch.core.job.parameters.JobParameter;
+import org.springframework.batch.core.job.parameters.JobParameters;
 import tools.jackson.core.type.TypeReference;
 import tools.jackson.databind.json.JsonMapper;
 import tools.jackson.databind.jsontype.BasicPolymorphicTypeValidator;
@@ -36,6 +39,7 @@
  * provide your own {@link JsonMapper} instance through the constructor.
  *
  * @author Mahmoud Ben Hassine
+ * @author Yanming Zhou
  * @since 6.0.0
  */
 public class JacksonExecutionContextStringSerializer implements ExecutionContextSerializer {
@@ -58,7 +62,10 @@ public JacksonExecutionContextStringSerializer() {
 			.allowIfSubType("java.xml.")
 			.allowIfSubType("org.springframework.batch.")
 			.build();
-		this.jsonMapper = JsonMapper.builder().activateDefaultTyping(polymorphicTypeValidator).build();
+		this.jsonMapper = JsonMapper.builder()
+			.activateDefaultTyping(polymorphicTypeValidator)
+			.addMixIns(Map.of(JobParameters.class, JobParametersMixIn.class))
+			.build();
 	}
 
 	/**
@@ -82,4 +89,15 @@ public void serialize(Map<String, Object> object, OutputStream outputStream) thr
 		this.jsonMapper.writeValue(outputStream, object);
 	}
 
+	@SuppressWarnings("unused")
+	private abstract static class JobParametersMixIn {
+
+		@JsonIgnore
+		abstract boolean isEmpty();
+
+		@JsonIgnore
+		abstract Map<String, JobParameter<?>> getIdentifyingParameters();
+
+	}
+
 }
diff --git a/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializerTests.java b/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializerTests.java
index 548359a33e..13fbf51b44 100644
--- a/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializerTests.java
+++ b/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/Jackson2ExecutionContextStringSerializerTests.java
@@ -31,19 +31,20 @@
 import com.fasterxml.jackson.annotation.JsonTypeInfo;
 import org.junit.jupiter.api.Test;
 
+import org.springframework.batch.core.job.parameters.JobParameter;
+import org.springframework.batch.core.job.parameters.JobParameters;
+import org.springframework.batch.core.job.parameters.JobParametersBuilder;
 import org.springframework.batch.core.repository.ExecutionContextSerializer;
 
-import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
-import static org.junit.jupiter.api.Assertions.assertEquals;
-import static org.junit.jupiter.api.Assertions.assertNotNull;
-import static org.junit.jupiter.api.Assertions.assertThrows;
-import static org.junit.jupiter.api.Assertions.assertTrue;
+import static org.junit.jupiter.api.Assertions.*;
 
 /**
  * @author Marten Deinum
  * @author Michael Minella
  * @author Mahmoud Ben Hassine
+ * @author Yanming Zhou
  */
+@SuppressWarnings("removal")
 class Jackson2ExecutionContextStringSerializerTests extends AbstractExecutionContextSerializerTests {
 
 	private final ExecutionContextSerializer serializer = new Jackson2ExecutionContextStringSerializer(
@@ -174,6 +175,7 @@ public static class UnmappedDomesticNumber extends UnmappedPhoneNumber {
 	}
 
 	@Test
+	@SuppressWarnings("unchecked")
 	void arrayAsListSerializationTest() throws IOException {
 		// given
 		List<String> list = Arrays.asList("foo", "bar");
@@ -232,4 +234,34 @@ void testJavaTimeLocalDateSerialization() throws IOException {
 		assertEquals(now, deserializedNow);
 	}
 
+	@Test
+	void testJobParametersSerialization() throws IOException {
+		// given
+		Jackson2ExecutionContextStringSerializer serializer = new Jackson2ExecutionContextStringSerializer();
+		LocalDate now = LocalDate.now();
+		JobParameters jobParameters = new JobParametersBuilder()
+			.addJobParameter("date", LocalDate.now(), LocalDate.class)
+			.addJobParameter("foo", "bar", String.class, false)
+			.toJobParameters();
+		Map<String, Object> map = new HashMap<>();
+		map.put("jobParameters", jobParameters);
+
+		// when
+		ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
+		serializer.serialize(map, outputStream);
+		InputStream inputStream = new ByteArrayInputStream(outputStream.toByteArray());
+		Map<String, Object> deserializedContext = serializer.deserialize(inputStream);
+
+		// then
+		JobParameters deserializedJobParameters = (JobParameters) deserializedContext.get("jobParameters");
+		JobParameter<?> dateJobParameter = deserializedJobParameters.getParameter("date");
+		assertNotNull(dateJobParameter);
+		assertEquals(now, dateJobParameter.value());
+		assertTrue(dateJobParameter.identifying());
+		JobParameter<?> fooJobParameter = deserializedJobParameters.getParameter("foo");
+		assertNotNull(fooJobParameter);
+		assertEquals("bar", fooJobParameter.value());
+		assertFalse(fooJobParameter.identifying());
+	}
+
 }
diff --git a/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializerTests.java b/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializerTests.java
index 90887a18d3..eadde985eb 100644
--- a/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializerTests.java
+++ b/spring-batch-core/src/test/java/org/springframework/batch/core/repository/dao/JacksonExecutionContextStringSerializerTests.java
@@ -27,13 +27,16 @@
 import java.util.Map;
 
 import org.junit.jupiter.api.Test;
+import org.springframework.batch.core.job.parameters.JobParameter;
+import org.springframework.batch.core.job.parameters.JobParameters;
+import org.springframework.batch.core.job.parameters.JobParametersBuilder;
 import tools.jackson.databind.json.JsonMapper;
 
-import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
-import static org.junit.jupiter.api.Assertions.assertEquals;
+import static org.junit.jupiter.api.Assertions.*;
 
 /**
  * @author Mahmoud Ben Hassine
+ * @author Yanming Zhou
  */
 class JacksonExecutionContextStringSerializerTests {
 
@@ -96,4 +99,34 @@ void testJavaTimeLocalDateSerialization() throws IOException {
 		assertEquals(now, deserializedNow);
 	}
 
+	@Test
+	void testJobParametersSerialization() throws IOException {
+		// given
+		JacksonExecutionContextStringSerializer serializer = new JacksonExecutionContextStringSerializer();
+		LocalDate now = LocalDate.now();
+		JobParameters jobParameters = new JobParametersBuilder()
+			.addJobParameter("date", LocalDate.now(), LocalDate.class)
+			.addJobParameter("foo", "bar", String.class, false)
+			.toJobParameters();
+		Map<String, Object> map = new HashMap<>();
+		map.put("jobParameters", jobParameters);
+
+		// when
+		ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
+		serializer.serialize(map, outputStream);
+		InputStream inputStream = new ByteArrayInputStream(outputStream.toByteArray());
+		Map<String, Object> deserializedContext = serializer.deserialize(inputStream);
+
+		// then
+		JobParameters deserializedJobParameters = (JobParameters) deserializedContext.get("jobParameters");
+		JobParameter<?> dateJobParameter = deserializedJobParameters.getParameter("date");
+		assertNotNull(dateJobParameter);
+		assertEquals(now, dateJobParameter.value());
+		assertTrue(dateJobParameter.identifying());
+		JobParameter<?> fooJobParameter = deserializedJobParameters.getParameter("foo");
+		assertNotNull(fooJobParameter);
+		assertEquals("bar", fooJobParameter.value());
+		assertFalse(fooJobParameter.identifying());
+	}
+
 }
