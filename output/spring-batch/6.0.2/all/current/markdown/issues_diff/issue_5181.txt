Issue #5181: MetaDataInstanceFactory default values cause StepContext collision in StepScopeTestUtils when @SpringBatchTest is active
Reference: PR #5208 (2026-01-11T10:45:09Z)
URL: https://github.com/spring-projects/spring-batch/pull/5208

--- Diff ---
diff --git a/spring-batch-test/src/main/java/org/springframework/batch/test/MetaDataInstanceFactory.java b/spring-batch-test/src/main/java/org/springframework/batch/test/MetaDataInstanceFactory.java
index a110e13282..a37aaa754b 100644
--- a/spring-batch-test/src/main/java/org/springframework/batch/test/MetaDataInstanceFactory.java
+++ b/spring-batch-test/src/main/java/org/springframework/batch/test/MetaDataInstanceFactory.java
@@ -16,6 +16,7 @@
 package org.springframework.batch.test;
 
 import java.util.Collection;
+import java.util.concurrent.atomic.AtomicLong;
 
 import org.springframework.batch.core.job.JobExecution;
 import org.springframework.batch.core.job.JobInstance;
@@ -58,6 +59,16 @@ public class MetaDataInstanceFactory {
 	 */
 	public static final long DEFAULT_STEP_EXECUTION_ID = 1234L;
 
+	/**
+	 * Atomic counter for generating unique job execution IDs in tests
+	 */
+	private static final AtomicLong jobExecutionIdCounter = new AtomicLong(DEFAULT_JOB_EXECUTION_ID);
+
+	/**
+	 * Atomic counter for generating unique step execution IDs in tests
+	 */
+	private static final AtomicLong stepExecutionIdCounter = new AtomicLong(DEFAULT_STEP_EXECUTION_ID);
+
 	/**
 	 * Create a {@link JobInstance} with the parameters provided.
 	 * @param jobName the name of the job
@@ -114,7 +125,7 @@ public static JobExecution createJobExecution(String jobName, Long instanceId, L
 	 * @return a {@link JobExecution}
 	 */
 	public static JobExecution createJobExecution(String jobName, Long instanceId, Long executionId,
-			JobParameters jobParameters) {
+		  JobParameters jobParameters) {
 		return new JobExecution(executionId, createJobInstance(jobName, instanceId), jobParameters);
 	}
 
@@ -170,6 +181,8 @@ public static JobExecution createJobExecutionWithStepExecutions(Long executionId
 	/**
 	 * Create a {@link StepExecution} and all its parent entities with default values, but
 	 * using the {@link ExecutionContext} and {@link JobParameters} provided.
+	 * Each invocation generates unique IDs to avoid collision in
+	 * {@link org.springframework.batch.core.scope.context.StepSynchronizationManager}.
 	 * @param jobParameters come {@link JobParameters}
 	 * @param executionContext some {@link ExecutionContext}
 	 * @return a {@link StepExecution} with the execution context provided
@@ -183,13 +196,17 @@ public static StepExecution createStepExecution(JobParameters jobParameters, Exe
 	/**
 	 * Create a {@link StepExecution} and all its parent entities with default values, but
 	 * using the {@link JobParameters} provided.
+	 * Each invocation generates unique IDs to avoid collision in
+	 * {@link org.springframework.batch.core.scope.context.StepSynchronizationManager}.
 	 * @param jobParameters some {@link JobParameters}
 	 * @return a {@link StepExecution} with the job parameters provided
 	 */
 	public static StepExecution createStepExecution(JobParameters jobParameters) {
-		JobExecution jobExecution = createJobExecution(DEFAULT_JOB_NAME, DEFAULT_JOB_INSTANCE_ID,
-				DEFAULT_JOB_EXECUTION_ID, jobParameters);
-		StepExecution stepExecution = createStepExecution(jobExecution, DEFAULT_STEP_NAME, DEFAULT_STEP_EXECUTION_ID);
+		Long jobExecutionId = jobExecutionIdCounter.incrementAndGet();
+		Long stepExecutionId = stepExecutionIdCounter.incrementAndGet();
+		JobExecution jobExecution = createJobExecution(DEFAULT_JOB_NAME, DEFAULT_JOB_INSTANCE_ID, jobExecutionId,
+				jobParameters);
+		StepExecution stepExecution = createStepExecution(jobExecution, DEFAULT_STEP_NAME, stepExecutionId);
 		jobExecution.addStepExecution(stepExecution);
 		return stepExecution;
 	}
diff --git a/spring-batch-test/src/test/java/org/springframework/batch/test/MetaDataInstanceFactoryTests.java b/spring-batch-test/src/test/java/org/springframework/batch/test/MetaDataInstanceFactoryTests.java
index 359621349c..0f4fee4a39 100644
--- a/spring-batch-test/src/test/java/org/springframework/batch/test/MetaDataInstanceFactoryTests.java
+++ b/spring-batch-test/src/test/java/org/springframework/batch/test/MetaDataInstanceFactoryTests.java
@@ -16,6 +16,7 @@
 package org.springframework.batch.test;
 
 import static org.junit.jupiter.api.Assertions.assertEquals;
+import static org.junit.jupiter.api.Assertions.assertNotEquals;
 import static org.junit.jupiter.api.Assertions.assertNotNull;
 
 import java.util.List;
@@ -106,4 +107,18 @@ void testCreateJobExecutionWithStepExecutions() {
 		assertNotNull(MetaDataInstanceFactory.createJobExecutionWithStepExecutions(executionId, List.of(stepName)));
 	}
 
+	@Test
+	void testCreateStepExecutionWithJobParametersShouldGenerateUniqueIds() {
+		JobParameters params1 = new JobParametersBuilder().addString("key", "value1").toJobParameters();
+		JobParameters params2 = new JobParametersBuilder().addString("key", "value2").toJobParameters();
+
+		StepExecution step1 = MetaDataInstanceFactory.createStepExecution(params1);
+		StepExecution step2 = MetaDataInstanceFactory.createStepExecution(params2);
+
+		assertNotEquals(step1.getId(), step2.getId());
+		assertNotEquals(step1.getJobExecutionId(), step2.getJobExecutionId());
+
+		assertNotEquals(step1, step2);
+	}
+
 }
