Issue #5217: OptimisticLockingFailureException due to race condition in graceful shutdown
Reference: PR #5219 (2026-01-18T19:34:10Z)
URL: https://github.com/spring-projects/spring-batch/pull/5219

--- Diff ---
diff --git a/spring-batch-core/src/main/java/org/springframework/batch/core/repository/support/SimpleJobRepository.java b/spring-batch-core/src/main/java/org/springframework/batch/core/repository/support/SimpleJobRepository.java
index d74608057a..6234889564 100644
--- a/spring-batch-core/src/main/java/org/springframework/batch/core/repository/support/SimpleJobRepository.java
+++ b/spring-batch-core/src/main/java/org/springframework/batch/core/repository/support/SimpleJobRepository.java
@@ -163,7 +163,7 @@ public void update(StepExecution stepExecution) {
 		Assert.state(latestStepExecution != null,
 				"StepExecution with id " + stepExecution.getId() + "not found. Batch metadata state may be corrupted.");
 
-		if (latestStepExecution.getJobExecution().isStopped()) {
+		if (latestStepExecution.getJobExecution().isStopped() || latestStepExecution.getJobExecution().isStopping()) {
 			Integer version = latestStepExecution.getVersion();
 			if (version != null) {
 				stepExecution.setVersion(version);
