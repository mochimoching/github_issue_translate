[
  {
    "number": 4755,
    "title": "Incorrect restart behaviour with no identifying job parameters",
    "state": "closed",
    "created_at": "2025-01-31T11:27:49Z",
    "updated_at": "2025-11-04T11:50:45Z",
    "author": "fmbenhassine",
    "url": "https://github.com/spring-projects/spring-batch/issues/4755",
    "body": "\n### Discussed in https://github.com/spring-projects/spring-batch/discussions/4694\n\n<div type='discussions-op-text'>\n\n<sup>Originally posted by **ELMORABITYounes** October 28, 2024</sup>\nRight now even if a job was completed successfuly, spring batch allow It to be restarted if It contains non identifying params as shown here:\n\n```\t\t\t\t\nif (!identifyingJobParameters.isEmpty()                                                        \n\t\t&& (status == BatchStatus.COMPLETED || status == BatchStatus.ABANDONED)) {            \n\tthrow new JobInstanceAlreadyCompleteException(                                             \n\t\t\t\"A job instance already exists and is complete for identifying parameters=\"       \n\t\t\t\t\t+ identifyingJobParameters + \".  If you want to run this job again, \"    \n\t\t\t\t\t+ \"change the parameters.\");                                             \n}                                                                                              \n```\n\nI am wondering why is that done like this? I mean if the job already completed why It does not throw JobInstanceAlreadyCompleteException? Shouldn't the second job instance without parameters  considered the same and hence not allow It to be restarted if already succeeded?\n</div>",
    "labels": [
      "type: bug",
      "in: core",
      "has: minimal-example"
    ],
    "comments": [
      {
        "author": "fmbenhassine",
        "created_at": "2025-01-31T11:31:15Z",
        "body": "Thank you for reporting this issue! I was able to isolate the case in this example:\n\n```java\npackage org.springframework.batch.samples.helloworld;\n\nimport org.springframework.batch.core.Job;\nimport org.springframework.batch.core.JobParameters;\nimport org.springframework.batch.core.JobParametersBuilder;\nimport org.springframework.batch.core.Step;\nimport org.springframework.batch.core.configuration.annotation.EnableBatchProcessing;\nimport org.springframework.batch.core.job.builder.JobBuilder;\nimport org.springframework.batch.core.launch.JobLauncher;\nimport org.springframework.batch.core.repository.JobRepository;\nimport org.springframework.batch.core.step.builder.StepBuilder;\nimport org.springframework.batch.repeat.RepeatStatus;\nimport org.springframework.context.ApplicationContext;\nimport org.springframework.context.annotation.AnnotationConfigApplicationContext;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseBuilder;\nimport org.springframework.jdbc.support.JdbcTransactionManager;\n\nimport javax.sql.DataSource;\n\n@Configuration\n@EnableBatchProcessing\npublic class HelloWorldJobConfiguration {\n\n\tpublic static void main(String[] args) throws Exception {\n\t\tApplicationContext context = new AnnotationConfigApplicationContext(HelloWorldJobConfiguration.class);\n\t\tJobLauncher jobLauncher = (JobLauncher) context.getBean(\"jobLauncher\");\n\t\tJob job = (Job) context.getBean(\"job\");\n\t\tJobParameters jobParameters1 = new JobParametersBuilder().addString(\"name\", \"foo\", false).toJobParameters();\n\t\tJobParameters jobParameters2 = new JobParametersBuilder().addString(\"name\", \"bar\", false).toJobParameters();\n\t\tjobLauncher.run(job, jobParameters1);\n\t\tjobLauncher.run(job, jobParameters2); // expected: JobInstanceAlreadyCompleteException\n\t}\n\n\t@Bean\n\tpublic Job job(JobRepository jobRepository, Step step) {\n\t\treturn new JobBuilder(\"job\", jobRepository).start(step).build();\n\t}\n\n\t@Bean\n\tpublic Step step(JobRepository jobRepository, JdbcTransactionManager transactionManager) {\n\t\treturn new StepBuilder(\"step\", jobRepository).tasklet((contribution, chunkContext) -> {\n\t\t\tSystem.out.println(\"Hello world!\");\n\t\t\treturn RepeatStatus.FINISHED;\n\t\t}, transactionManager).build();\n\t}\n\n\t// infra beans\n\n\t@Bean\n\tpublic DataSource dataSource() {\n\t\treturn new EmbeddedDatabaseBuilder()\n\t\t\t\t.addScript(\"/org/springframework/batch/core/schema-hsqldb.sql\")\n\t\t\t\t.build();\n\t}\n\n\t@Bean\n\tpublic JdbcTransactionManager transactionManager(DataSource dataSource) {\n\t\treturn new JdbcTransactionManager(dataSource);\n\t}\n\n}\n```\n\nwhile the default job key generator works as expected (it gives the same hash for the same input, ie an empty identifying job parameters set), spring batch still considers this as a different job instance and runs it, which should not be the case.\n\n---\n\nJust FTR,  the default job key generator is working as expected (the following tests pass with 5.2.1):\n\n```java\n// to add in org.springframework.batch.core.DefaultJobKeyGeneratorTests\n\n\t@Test\n\tpublic void testCreateJobKeyForEmptyParameters() {\n\t\tJobParameters jobParameters1 = new JobParameters();\n\t\tJobParameters jobParameters2 = new JobParameters();\n\t\tString key1 = jobKeyGenerator.generateKey(jobParameters1);\n\t\tString key2 = jobKeyGenerator.generateKey(jobParameters2);\n\t\tassertEquals(key1, key2);\n\t}\n\n\t@Test\n\tpublic void testCreateJobKeyForEmptyParametersAndNonIdentifying() {\n\t\tJobParameters jobParameters1 = new JobParameters();\n\t\tJobParameters jobParameters2 = new JobParametersBuilder()\n\t\t\t\t.addString(\"name\", \"foo\", false)\n\t\t\t\t.toJobParameters();\n\t\tString key1 = jobKeyGenerator.generateKey(jobParameters1);\n\t\tString key2 = jobKeyGenerator.generateKey(jobParameters2);\n\t\tassertEquals(key1, key2);\n\t}\n```"
      },
      {
        "author": "baezzys",
        "created_at": "2025-04-29T11:45:52Z",
        "body": "Hi @fmbenhassine Can I work on this?"
      },
      {
        "author": "isanghaessi",
        "created_at": "2025-08-15T14:23:02Z",
        "body": "Hi @fmbenhassine ðŸ‘‹\nI opened PR for this issue #4946!\nPlease review and I will check ASAPðŸ’¨"
      }
    ],
    "closing_references": {
      "pull_requests": [],
      "commits": [
        "1c28daccf0958e2cdcfd1a784e3f7110e73881e4",
        "250bfff1b6e8f2cf4e9219564c3f1d2719f0d17d",
        "5225249585fec7e479bf4b3194974d96a848c3c0",
        "0564ce6293e5178b12aa95b7bce5a461a38e4eb0",
        "f888ebb43f70d925c028721db0b3d71306089038"
      ]
    }
  }
]