*（このドキュメントは生成AI(Claude Opus 4.5)によって2026年1月27日に生成されました）*

# StepExecutionListener#afterStepでステップのステータスが不正確

**Issue番号**: #4362

**状態**: closed | **作成者**: cezarykluczynski | **作成日**: 2023-05-01

**ラベル**: type: bug, in: core

**URL**: https://github.com/spring-projects/spring-batch/issues/4362

**関連リンク**:
- Commits:
  - [36068b5](https://github.com/spring-projects/spring-batch/commit/36068b5db84ff242032e9b00515454a84e0745d2)
  - [db6ef7b](https://github.com/spring-projects/spring-batch/commit/db6ef7b067e0daeee59c1baea03a0acfed4f5cfc)

## 内容

ステップ完了時にコールバックを実行する方法を探しています。`StepExecutionListener`は使えません。なぜなら、`afterStep`が呼ばれた時点ではステップは実際にはまだ完了しておらず、終了ステータスはまだ変更される可能性があり、データベーステーブル上のステータスもCOMPLETEDではなくSTARTEDのままだからです。

この機能が必要な理由は、各ステップの後に完了したステップの自動バックアップを実行したいからです。そのためには、すべてのステップが完了している必要があります。もしバックアップから状態を復元した場合、Spring Batchはそれ以降の処理を実行しなくなってしまうからです。

クリーンな方法でこれを実現する手段が見つかりませんでした。あるステップが完了した後、次のステップがまだ開始されていない時点で実行されるリスナーが存在しません。もしそのようなリスナーがあれば教えていただきたいですし、なければそのようなリスナーの追加を検討していただけないでしょうか？この機能が受け入れられるのであれば、PRを作成することも可能です。

## コメント

### コメント 1 by fmbenhassine

**作成日**: 2023-06-15

この課題を報告いただきありがとうございます。

> `StepExecutionListener`は使えません。なぜなら、`afterStep`が呼ばれた時点ではステップは実際にはまだ完了しておらず、終了ステータスはまだ変更される可能性があり、データベーステーブル上のステータスもCOMPLETEDではなくSTARTEDのままだからです。

問題は、Spring Batchにおけるこのコールバックリスナーの現在の実装が正しくないことにあります。このメソッドの契約では「ステップの処理ロジックの実行後（成功・失敗を問わず）に呼び出される」と規定されています。したがって、その時点でのステータスは（メモリ上もデータベース上も）STARTEDではなく、実行中でないステータスであるべきです。終了時刻もその時点で設定されているべきです（[#3846](https://github.com/spring-projects/spring-batch/issues/3846) で報告されている通り）。したがって、これは新機能のリクエストではなくバグだと考えています。

この問題が修正されれば、`StepExecutionListener`で要件を実装できるようになると思います。同意いただけますか？

### コメント 2 by cezarykluczynski

**作成日**: 2023-06-22

@fmbenhassine はい、メモリ上とデータベース上の両方でステータスが実行中でない状態になれば、私の問題は解決します。ただし、`afterStep`メソッドは「通常の値と組み合わせる`ExitStatus`」を返すようになっており、これにより元の終了ステータスを上書きする機会が与えられています。そのため、null以外のステータスが返された場合は、`AbstractStep`の268行目付近でもう一度保存が必要になります（それだけで済めばの話ですが）。また、たとえバグに依存しているとしても、Spring Batchの動作について他の人が前提としていることを壊してしまわないか確信が持てません。

### コメント 3 by gdupontf

**作成日**: 2023-08-16

間違っていたら申し訳ないのですが、ジョブレベルでも同じ問題がありませんか？
`JobExecutionListener`を使用した際に同じ動作を経験しました。

### コメント 4 by fmbenhassine

**作成日**: 2025-11-03

> はい、メモリ上とデータベース上の両方でステータスが実行中でない状態になれば、私の問題は解決します

@cezarykluczynski ステップ実行のステータスは、リスナーを呼び出す前に永続化されるようになりました。そのため、メモリ上でもジョブリポジトリ上でも実行中でないステータスとして確認できるはずです（ただし、その時点でジョブリポジトリに問い合わせるべきではなく、リスナーに渡されるステップ実行への参照のみを使用すべきだと考えています）。

とはいえ、改めて考えてみると、なぜ`afterStep`が`ExitStatus`を返すのか理解できません。Javadocには「リスナーにステップの終了ステータスを変更する機会を与えるため」と書かれていますが、そのユースケースが思いつきません（何か見落としているかもしれませんが）。私自身、この「機能」を使ったことは一度もありません。さらに、これは`JobExecutionListener#afterJob`との一貫性がありません。こちらは`ExitStatus`ではなく`void`を返します。なぜ`StepExecutionListener#afterStep`ではステップの実行ステータスを変更できるのに、`JobExecutionListener#afterJob`ではジョブの実行ステータスを変更できないのでしょうか？

正当な理由やユースケースがない限り、このメソッドは非推奨とし、`void`を返すメソッドに置き換えるべきだと考えています。これについて議論しフィードバックを集めるために [#5074](https://github.com/spring-projects/spring-batch/issues/5074) を作成しましたので、ぜひご意見をお聞かせください。よろしくお願いいたします。

@gdupontf

> 間違っていたら申し訳ないのですが、ジョブレベルでも同じ問題がありませんか？`JobExecutionListener`を使用した際に同じ動作を経験しました。

おっしゃる通りです。ジョブリスナーについても修正しました。36068b5db84ff242032e9b00515454a84e0745d2
