# Add Bean instantiation generator infrastructure

**Issue番号**: #28047

**状態**: closed | **作成者**: snicoll | **作成日**: 2022-02-14

**ラベル**: in: core, type: enhancement, theme: aot

**URL**: https://github.com/spring-projects/spring-framework/issues/28047

**関連リンク**:
- Commits:
  - [9809752](https://github.com/spring-projects/spring-framework/commit/9809752c3c9b77e4fa6d1e06c9e1b080b6affb17)
  - [c541bde](https://github.com/spring-projects/spring-framework/commit/c541bde513443862e24e372c83f33e8c511d8903)
  - [572d017](https://github.com/spring-projects/spring-framework/commit/572d0173703e15a80e76eac2ad0bea9c56f35326)
  - [ea19b92](https://github.com/spring-projects/spring-framework/commit/ea19b92deb44fc74c04da6771afd714efeb79521)
  - [97986b3](https://github.com/spring-projects/spring-framework/commit/97986b368a42f858a8f6ee84e2ca4a79f17e7410)
  - [c5e1a77](https://github.com/spring-projects/spring-framework/commit/c5e1a774a5a1e27eb1ca693b663ec37e6583ac41)
  - [20b17f0](https://github.com/spring-projects/spring-framework/commit/20b17f02a29de8f10773d400b92f310fc6aba5a2)

## 内容

As part of our AOT effort, we need an infrastructure that lets us generate the code to instantiate a bean.

This includes some low-level code generation infrastructure to write method calls, parameters, etc, as well as an API that can be used to contribute to the bean instance. 

Such contributors should namely be based on the existing `BeanPostProcessor` infrastructure as they augment a bean instance with some logic that can be translated into code during the AOT phase. As BPP are ordered, so can their contributions so that the order in which they are applied by executing generated code matches.

To ease code generation, we need an infrastructure that focuses on something quite basic for a first version, something like:

```java
BeanDefinitionRegistrar.of("restTemplateClientService", RestTemplateClientService.class)
	  .withConstructor(RestTemplateBuilder.class)
	  .instanceSupplier((instanceContext) -> instanceContext.create(beanFactory, (attributes) ->
			  new RestTemplateClientService(attributes.get(0))))
	  .register(beanFactory);
```

This registeres a `restTemplateClientService` bean that requires a `RestTemplateBuilder`. Rather than doing all the dependency resolution at build-time, we leverage framework's dependency resolution algorithm, via the `instanceContext` who can provide us resolved attributes according to `Executable` to use to instantiate the bean (here a constructor that takes a `RestTemplateBuilder`).

