# Hibernate 6との互換性のためのHibernateJpaDialect(読み取り専用トランザクションなど)

**Issue番号**: #28007

**状態**: closed | **作成者**: odrotbohm | **作成日**: 2022-02-04

**ラベル**: in: data, type: enhancement

**URL**: https://github.com/spring-projects/spring-framework/issues/28007

**関連リンク**:
- Commits:
  - [d07e1be](https://github.com/spring-projects/spring-framework/commit/d07e1be623b607c77afe6faf8c02eda8a1b0b110)

## 内容

Spring Data JPAでHibernate 6との互換性を調査する作業中に、Spring Frameworkのトランザクション管理で問題が発生しました。

`….beginTransaction(…)`において、`HibernateJpaDialect`は読み取り専用トランザクションを発行するために`SessionImplementor.connection()`メソッドを呼び出していますが、このメソッドはCR1で削除されました(おそらくベータ版のいずれかですでに削除されていた可能性がありますが、確認していません)。`Connection`にアクセスする新しい方法は、`….getJdbcConnectionAccess().obtainConnection()`を呼び出すことのようです。

関連チケット:
* spring-projects/spring-data-jpa#2423

## コメント

### コメント 1 by jhoeller

**作成日**: 2022-02-04

Hibernate 6.0の完全なサポートストーリーは、独自の6.0 M3を目指していますが、どこまで進めるかはまだ決まっていません(ネイティブAPI経由で`orm.hibernate6`? それともJPAだけ? Hibernate 5.xサポートを並行して維持? など): #22128

とはいえ、少なくともJPAサポートでHibernate 6.0を使用できるように5.3.xで何ができるかを検討する価値は間違いなくあります。最初は、完全な調整なしで、実行時に寛容に許容することから始めたいと思います。このチケットをそのために使用しましょう。

### コメント 2 by odrotbohm

**作成日**: 2022-02-04

単純な`@Transactional`を使用して読み取り専用トランザクションを回避すると、Boot 3 M1でHibernate 6 CR1を使用する統合テストは問題なく実行されました。つまり、最初はその特定の問題だけかもしれません。そのため、実行可能なものについてチケットを開こうと思いました。もちろん、お任せします。

ああ、H6はJakartaEEベースです。5.x世代でのサポートにとって、これは障壁だと思います。

### コメント 3 by jhoeller

**作成日**: 2022-02-04

良い指摘です。もはやクラシックなJPAバインディングはなく、確かに`jakarta.persistence`上に独占的に構築されています。また、ネイティブHibernate APIに多くの非互換性があるため、`orm.hibernate5`でも使用できません。わかりました。Hibernate ORM 6.0はSpring Framework 6.0専用のトピックになります :-)

### コメント 4 by jhoeller

**作成日**: 2022-02-04

わかりました。6.0 M3では、このチケットを使用して、`HibernateJpaDialect`の互換性を最初に確実に解決します。完全なHibernate 6.0の調整、あるいはHibernate 6.0のベースライン化には、いずれにせよもっと時間がかかるかもしれません。その部分には#22128を使用しましょう。

### コメント 5 by odrotbohm

**作成日**: 2022-02-04

私が見つけた回避策として提案したAPI(自分でテストしたことはありませんが)は、5.6.5にもすでに存在していることに気づきました。つまり、6.0で単純に移行しようとすることができますが、Hibernate 5.xベースラインに固執します。

### コメント 6 by jhoeller

**作成日**: 2022-02-04

実際、`HibernateJpaDialect`の改訂を通じて、Hibernate 5.6と6.0の両方をサポートすることは簡単であることがわかりました。セッションが保持する現在の接続を取得するための正しい置き換えは、接続リリースモードが適切である限り、`getJdbcCoordinator().getLogicalConnection().getPhysicalConnection()`です。これは5.6と6.0の両方で問題なく動作するようです。

影響を受けるもう1つの領域は、`HibernateJpaVendorAdapter`とデータベース列挙型のデフォルトダイアレクトの選択です。これらのダイアレクトは非推奨になったようで、Informixダイアレクトは完全になくなりました。しかし、いずれにせよ明示的なHibernateダイアレクト設定を推奨しているため(データベース列挙型に依存するのではなく)、これは大きな問題ではないはずです。

その観点から、JPA互換性の面ではカバーされているようなので、すぐにこのチケットをクローズします。#22128の残りの主な部分は、`orm.hibernate5`の隣に`orm.hibernate6`パッケージが必要か、または`orm.hibernate5`の置き換えとして必要かということです。これは主に、既存の`orm.hibernate5`ユーザーに何を推奨するかに依存します:Hibernate 5.6にとどまるか、`orm.hibernate6`経由でHibernate 6.0にアップグレードするか、またはJPA経由でHibernate 6.0にアップグレードするか。

### コメント 7 by odrotbohm

**作成日**: 2022-02-08

ありがとう、Jürgen。期待通りに動作することを確認しました! 🙇
