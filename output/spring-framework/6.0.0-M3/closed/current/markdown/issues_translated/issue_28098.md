# 型安全なトランザクションロールバックルールのサポート

**Issue番号**: #28098

**状態**: closed | **作成者**: hduyyg | **作成日**: 2022-02-23

**ラベル**: in: data, type: enhancement

**URL**: https://github.com/spring-projects/spring-framework/issues/28098

**関連リンク**:
- Commits:
  - [c1033db](https://github.com/spring-projects/spring-framework/commit/c1033dbfb3609f3b3fe002d7b582b3302620c05a)
  - [67b91b2](https://github.com/spring-projects/spring-framework/commit/67b91b239091afe169045cf0dafa800aaa5884aa)

## 内容

問題のソースコード:

```java
private int getDepth(Class<?> exceptionClass, int depth) {
	if (exceptionClass.getName().contains(this.exceptionName)) {
		// Found it!
		return depth;
	}
	// If we've gone as far as we can go and haven't found it...
	if (exceptionClass == Throwable.class) {
		return -1;
	}
	return getDepth(exceptionClass.getSuperclass(), depth + 1);
}
```

テストコード:

```java
public class CustomException extends Exception {
}

public class CustomExceptionX extends Exception {
}

@Override
@Transactional(rollbackFor = CustomException.class)
public void testTransaction() throws Exception {
    taskMapper.softDeleteById(1, "test");
    if (1 == 1) {
        throw new CustomExceptionX();
    }
}
```

## コメント

### コメント 1 by sbrannen

**作成日**: 2022-02-28

これは設計によるもので、もともとXML設定ファイルで使用するために`contains()`を使用して実装されました。ユーザーは、カスタム例外タイプの_完全修飾クラス名_の代わりに_単純名_を指定することがよくありました。

これの例は[リファレンスドキュメント](https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#transaction-declarative-rolling-back)で確認できます。

```xml
<tx:advice id="txAdvice" transaction-manager="txManager">
  <tx:attributes>
    <tx:method name="get*" read-only="true" rollback-for="NoProductInStockException"/>
    <tx:method name="*"/>
  </tx:attributes>
</tx:advice>
```

`contains()`の代わりに`equals()`を使用するという提案では、`NoProductInStockException`が_デフォルト_パッケージのトップレベルクラスとして宣言されている場合にのみ完全修飾クラス名と等しくなるため、そのような設定は機能しなくなります。これはかなりありそうにないことです。

[`RollbackRuleAttribute`のJavadoc](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/interceptor/RollbackRuleAttribute.html#RollbackRuleAttribute-java.lang.String-)にも注意してください:

> **NB**: パターンがどの程度具体的か、そしてパッケージ情報を含めるか(これは必須ではありません)を慎重に検討してください。たとえば、"Exception"はほとんどすべてに一致し、おそらく他のルールを隠してしまいます。"Exception"がすべてのチェック例外のルールを定義することを意図している場合、"java.lang.Exception"が正しいでしょう。"BaseBusinessException"のようなより珍しい例外名では、完全なパッケージ修飾名を使用する必要はありません。

`@Transactional`の`rollbackForClassName`属性にも同様のドキュメントが存在します。

----

`RollbackRuleAttribute(Class)`コンストラクタのJavadocには次のように記載されています。

> RollbackRuleAttributeクラスの新しいインスタンスを作成します。
> 
> これは、提供されたExceptionクラス、そのサブクラス、およびそのネストされたクラスに一致するロールバックルールを構築するための推奨される方法です。

しかし、その最後の文は現在の実装では守られていません。なぜなら、型情報(`Class`参照を介して提供される)が`getDepth(...)`の実装で考慮されていないためです。

### コメント 2 by sbrannen

**作成日**: 2022-03-01

前の発言を訂正します。`RollbackRuleAttribute(Class)`コンストラクタのJavadocは_ほとんど_正しいです。

しかし、ロールバックルールのドキュメントは、スローされた例外の名前が登録された例外タイプの名前を_含んでいる_場合に意図しないマッチが発生する可能性があることを警告するように改善できます。

したがって、この課題をドキュメントの改善のために転用します。

### コメント 3 by hduyyg

**作成日**: 2022-03-02

このロールバックルールには誤りがあり、より正確なマッチングルールが必要だと思います。

多くの人は実際にはドキュメントを読みません。

### コメント 4 by sbrannen

**作成日**: 2022-03-02

> このロールバックルールには誤りがあり、より正確なマッチングルールが必要だと思います。

同意します。`5.3.x`のドキュメントを改善するために#28125を提起しました。

そして、_この_課題を`6.0`での動作を改善するために使用します。

具体的には:

- _例外パターン_が`String`として提供される場合 -- たとえば、XML設定や`@Transactional(rollbackForClassName = "example.CustomException")`を介して -- 既存の`contains()`ロジックが引き続き使用されます。
- 具体的な_例外タイプ_が`Class`参照として提供される場合 -- たとえば、`@Transactional(rollbackFor = example.CustomException.class)`を介して -- 提供された型情報を尊重する新しいロジックが実装され、`example.CustomException`(`2`なし)が例外タイプとして提供されたときに`example.CustomException2`に対する意図しないマッチを回避します。
