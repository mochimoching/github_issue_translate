# MergedAnnotationsの「enclosing classes」検索戦略を非推奨化

**Issue番号**: #28079

**状態**: closed | **作成者**: sbrannen | **作成日**: 2022-02-19

**ラベル**: in: core, type: enhancement

**URL**: https://github.com/spring-projects/spring-framework/issues/28079

**関連リンク**:
- Commits:
  - [29d9828](https://github.com/spring-projects/spring-framework/commit/29d98285bea8be459d0bdcaad655c84338c3d0e5)
  - [5689395](https://github.com/spring-projects/spring-framework/commit/5689395678f57fe967a3b21ed7d9087cfec7b622)
  - [b97a3ae](https://github.com/spring-projects/spring-framework/commit/b97a3ae07aa29d9c55c95f54c50b5558564a87c5)
  - [fc8f31c](https://github.com/spring-projects/spring-framework/commit/fc8f31ccfbecd2179d7ce216a5a3521f13397c05)
  - [c9cd53f](https://github.com/spring-projects/spring-framework/commit/c9cd53f469a7b3a79284542fe0222b0f9fd05785)

## 内容

### 概要

`MergedAnnotations`の`TYPE_HIERARCHY_AND_ENCLOSING_CLASSES`検索戦略は、もともとJUnit Jupiterの`@Nested`テストクラスをサポートするために導入されました。

しかし、#19930の実装中に、この検索戦略は残念ながら使用できないと判断しました。なぜなら、enclosingクラス階層をいつ再帰的に検索するかをユーザーが制御できないためです。たとえば、この検索戦略は、static nestedクラスとinner classの両方について自動的にenclosingクラスを検索しますが、ユーザーはおそらくそのような「enclosing class」のカテゴリーの1つだけを検索したいと考えています。その結果、`TYPE_HIERARCHY_AND_ENCLOSING_CLASSES`検索戦略の欠点に対処するため、_Spring TestContext Framework_に[`TestContextAnnotationUtils`](https://github.com/spring-projects/spring-framework/blob/main/spring-test/src/main/java/org/springframework/test/context/TestContextAnnotationUtils.java)が導入されました。

この検索戦略は一般ユーザーにとって有用である可能性が低いため、チームはSpring Framework 6.0でこの検索戦略を非推奨にすることを検討すべきです。

### 関連課題

- #19930
- #23378
- #28080

## コメント

### コメント 1 by philwebb

**作成日**: 2022-03-11

@sbrannnen Spring Bootでは、ネストされたクラスから`@ConstructorBinding`アノテーションを見つけるためにこの戦略を使用しています。非推奨化を再考できますか?

### コメント 2 by sbrannen

**作成日**: 2022-03-12

こんにちは@philwebbさん、

BootのConfigurationPropertiesBeanで一度使用されていたのは見ましたが、もうそうではないようです。

Spring Bootで`TYPE_HIERARCHY_AND_ENCLOSING_CLASSES`はまだどこで使用されていますか?

### コメント 3 by snicoll

**作成日**: 2022-03-12

こちらです: https://github.com/spring-projects/spring-boot/blob/de321b00b7d0f2c5c1c79a77e7241b43fbcd8313/spring-boot-project/spring-boot-actuator/src/main/java/org/springframework/boot/actuate/context/properties/ConfigurationPropertiesReportEndpoint.java#L559

`main`では使用していません。`@ConstructorBinding`のセマンティクスが進化し、この方法で検索する必要がなくなったためです。

### コメント 4 by sbrannen

**作成日**: 2022-03-13

リンクと説明をありがとうございます、@snicollさん。

検索戦略がFramework 5.3.xに対する`@ConstructorBinding`にのみ使用され、Boot 3.0+(Framework 6.0+に依存)ではもう使用されていない場合、Framework 5.3.xで検索戦略を非推奨化し、6.0で削除することに問題はありますか?

### コメント 5 by snicoll

**作成日**: 2022-03-13

はい、そう思います。私たちのポリシーは、絶対に必要でない限り、非推奨コードに依存しないことです。`2.x`ライン全体の期間中にこの状況に陥るのは理想的とは言えず、おそらくフレームワークで非推奨コードを使用しないようにコードをコピーするでしょう。

この機会に、冒頭の記述に同意しません。非常に特定のユースケースのために導入されたかもしれませんが、一度公開APIになれば、これが唯一の用途だと実際に主張することはできません。[TestContextAnnotationUtils](https://github.com/spring-projects/spring-framework/blob/main/spring-test/src/main/java/org/springframework/test/context/TestContextAnnotationUtils.java)への追加が問題を修正しているようですが、少なくとも私たちにとってはそうではありません。

### コメント 6 by sbrannen

**作成日**: 2022-03-16

`5.3.x`ラインについては、チームは`TYPE_HIERARCHY_AND_ENCLOSING_CLASSES`検索戦略を非推奨化しないことを決定しました。

代わりに、検索戦略の動作に対する認識を高めるために、ドキュメントに注記を追加します。

さらに、`6.0.x`で検索戦略の非推奨化/削除を再考します。

### コメント 7 by sbrannen

**作成日**: 2022-03-16

**チームの決定**: 6.0 M3で`TYPE_HIERARCHY_AND_ENCLOSING_CLASSES`検索戦略を非推奨化することを決定しました。これにより、6.0マイルストーンとリリース候補のユーザーが、6.0 GAより前に完全に削除したり、同じ目標を達成するための代替メカニズムを提供する前に、フィードバックを提供できるようになります。

- 詳細は#28080を参照
