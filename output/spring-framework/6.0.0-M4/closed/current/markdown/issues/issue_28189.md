# Support "application/problem+json" as the response Content-Type

**Issue番号**: #28189

**状態**: closed | **作成者**: rstoyanchev | **作成日**: 2022-03-16

**ラベル**: in: web, type: enhancement

**URL**: https://github.com/spring-projects/spring-framework/issues/28189

**関連リンク**:
- Commits:
  - [8378af9](https://github.com/spring-projects/spring-framework/commit/8378af9e397afe6bf5d91d16a22edf69912af408)
  - [78ab4d7](https://github.com/spring-projects/spring-framework/commit/78ab4d711812c754dc8a9b3021805899bfc5c9fe)

## 内容

Once  #28187 provides `ProblemDetail` along with the `ErrorResponse` hierarchy of exceptions that encapsulate HTTP status, headers, and body, to support RFC 7807, it is also necessary to improve content negotiation and formatting specifically for error responses.

In Spring MVC it is possible to configure [content type resolution](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-content-negotiation) and [message conversion](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-config-message-converters) and likewise in WebFlux to configure [content type resolution](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-config-content-negotiation) and [message codecs](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-config-message-codecs), but those apply to both `@RequestMapping` and `@ExceptionHandler` methods. 

Error handling however has a different perspective. The range of supported media types might be more limited and different, e.g. only `application/problem+json`. The resolution of the request content type might also be done differently, .e.g. defaulting to `application/problem+json` if not explicitly requested, or perhaps even enforcing it.

Such a mechanism is also a convenient place for other configuration related to how `ProblemDetail` should be rendered..


## コメント

### コメント 1 by rstoyanchev

**作成日**: 2022-05-09

On closer investigation, this can be handled transparently as follows.

Message converters and encoders indicate a preference for `application/problem+json` when `ProblemType` is serialized. This ensures `application/problem+json` is preferred when the client is flexible or has no preference.

If content negotiation fails to find an acceptable media type for serializing `ProblemDetail`, we try again with `application/problem+json` and `application/problem+xml` as the acceptable media types, in effect enforcing a fallback for `ProblemDetail`. 


