# HtmlUnit WebClientでエンコードされたURLを使用するとStrictHttpFirewallがリクエストを拒否する

**Issue番号**: [#27837](https://github.com/spring-projects/spring-framework/issues/27837)

**状態**: closed | **作成者**: thuri | **作成日**: 2021-12-18

**ラベル**: in: test, type: bug

**URL**: https://github.com/spring-projects/spring-framework/issues/27837

**関連リンク**:
- Commits:
  - [9346c89](https://github.com/spring-projects/spring-framework/commit/9346c89f5c215456167799159ca5a8150762855d)
  - [3477ec0](https://github.com/spring-projects/spring-framework/commit/3477ec0a35c5d19d55431f756cc9c6056ee788da)

## 内容

**影響バージョン:** 5.3.13

---

HtmlUnit Webclientを使用してSpring Bootプロジェクトのユニットテストを実行しようとしています。

このテストでは、フォームデータをControllerに送信するPOSTリクエストを実行し、データベースエントリを作成してクライアントにリダイレクトを送信します。レスポンスのLocationヘッダーには、必要に応じてエンコードされたURLが含まれます。

すべて正常に動作していましたが、HtmlUnit Webclientがリダイレクトをフォローしようとするときに`org.springframework.security.web.firewall.StrictHttpFirewall.getFirewalledRequest(HttpServletRequest)`メソッドが呼び出され、リクエストの処理が阻止されます。URLに含まれる%について苦情を出しています(スタックトレースを参照)。

しかし、アプリケーションを実行して実際のブラウザを使用すると、この問題は発生しません。Web上を検索したところ、[#16067](https://github.com/spring-projects/spring-framework/issues/16067)が似ているように見えました。

そこで、この問題を再現するための小さな[プロジェクト](https://github.com/thuri/encoded-uri-test)を作成しました。HtmlUnit WebClientの問題は少し異なると思います。

`webClientTestStringWithEncoding`テストメソッドを実行し、`org.springframework.security.web.firewall.StrictHttpFirewall#rejectedBlocklistedUrls(HttpServletRequest)`をデバッグすると、`request.getServletPath()`がまだエンコードされたパスを含んでいるのに対し、呼び出されたメソッド`decodedUrlContains`はデコードされていることを期待しているようです。

`mockMvcTestURI`テストメソッドを実行して同じ行をデバッグすると、`request.getServletPath()`が空で、`request.getPathInfo()`にデコードされたパスが含まれていることがわかります。`request.getRequestURI()`は両方のケースでエンコードされたパスを含んでいます。

最初のテストがwebclientを使用し、もう1つがmockMvcを使用している理由を不思議に思われるかもしれませんが、HtmlUnit Webclientにエンコードされたバージョンまたはエンコードされていないバージョン(スペースとウムラウトを含む)を渡す方法が見つかりませんでした(他のテストメソッドでわかるように)。

おそらく問題は、`org.springframework.test.web.servlet.htmlunit.HtmlUnitRequestBuilder.buildRequest(ServletContext)`にあり、リクエストに`servletPath`が設定される場所でデコードする必要があります。

テストでこの問題を回避できると思いますが、これについて見ていただければ幸いです。

よろしくお願いいたします。
Michael

```stacktrace
java.io.IOException: org.springframework.security.web.firewall.RequestRejectedException: The request was rejected because the URL contained a potentially malicious String "%"
	at org.springframework.test.web.servlet.htmlunit.MockMvcWebConnection.getResponse(MockMvcWebConnection.java:152)
	at org.springframework.test.web.servlet.htmlunit.MockMvcWebConnection.getResponse(MockMvcWebConnection.java:134)
	at org.springframework.test.web.servlet.htmlunit.DelegatingWebConnection.getResponse(DelegatingWebConnection.java:79)
	at com.gargoylesoftware.htmlunit.WebClient.loadWebResponseFromWebConnection(WebClient.java:1596)
	at com.gargoylesoftware.htmlunit.WebClient.loadWebResponse(WebClient.java:1518)
	at com.gargoylesoftware.htmlunit.WebClient.getPage(WebClient.java:493)
	at com.gargoylesoftware.htmlunit.WebClient.getPage(WebClient.java:413)
	at com.gargoylesoftware.htmlunit.WebClient.getPage(WebClient.java:548)
	at com.gargoylesoftware.htmlunit.WebClient.getPage(WebClient.java:529)
	at io.gitlab.thuri.spring.htmlunit.TestWithEncodedUriIssue.webClientTestStringWithEncoding(TestWithEncodedUriIssue.java:63)
	// JUnitとEclipseのスタックトレースエントリは省略

Caused by: org.springframework.security.web.firewall.RequestRejectedException: The request was rejected because the URL contained a potentially malicious String "%"
	at org.springframework.security.web.firewall.StrictHttpFirewall.rejectedBlocklistedUrls(StrictHttpFirewall.java:463)
	at org.springframework.security.web.firewall.StrictHttpFirewall.getFirewalledRequest(StrictHttpFirewall.java:429)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:196)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:183)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:358)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:271)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:134)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:134)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:134)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.springframework.mock.web.MockFilterChain.doFilter(MockFilterChain.java:134)
	at org.springframework.test.web.servlet.MockMvc.perform(MockMvc.java:199)
	at org.springframework.test.web.servlet.htmlunit.MockMvcWebConnection.getResponse(MockMvcWebConnection.java:149)
	... 78 more
```

## コメント

### コメント 1 by rstoyanchev

**作成日**: 2022-01-05

`HtmlUnitRequestBuilder`は、エンコードされたパスを含むURL、つまりエンコードされていないがHtmlUnitの`WebClient`が`java.net.URL`を準備する際にエンコードされるパスを十分にサポートしていないようです。指摘された通り、問題はservletPathがデコードされているべきなのに、`HtmlUnitRequestBuilder`は本質的に[フルパス](https://github.com/spring-projects/spring-framework/blob/338f8907ac752718b9432ca268d9e6de25cba705/spring-test/src/main/java/org/springframework/test/web/servlet/htmlunit/HtmlUnitRequestBuilder.java#L411)からcontextPathを引いたものをそのまま使用し、さらなるデコードを行っていないことです。

これがそれほど失敗しなかった理由の1つは、BootアプリはデフォルトでalwaysUseFullPathが設定されているため、実質的にservletPathがマッピング目的で使用されず、Spring Securityのファイアウォールのみが影響を受けるからです。

これは修正できると思います。他の選択肢は見当たらず、servletPathはマッピング目的で頻繁に使用されるわけではないため、問題を引き起こすべきではないと考えます。いずれにせよ、デコードされているべきです。
