# Add support for `@Transactional` in native images

**Issue番号**: #28717

**状態**: closed | **作成者**: mhalbritter | **作成日**: 2022-06-28

**ラベル**: in: data, theme: aot

**URL**: https://github.com/spring-projects/spring-framework/issues/28717

**関連リンク**:
- Commits:
  - [c77a3bc](https://github.com/spring-projects/spring-framework/commit/c77a3bcc4f13624c40874a2e9148353126fc49f7)
  - [69739e5](https://github.com/spring-projects/spring-framework/commit/69739e5e87ae0fdec8c6bef797012860151f51a3)
  - [0387d54](https://github.com/spring-projects/spring-framework/commit/0387d54607f371b7ff9e28dd8a89ec6203d3a09b)
  - [8d12d4d](https://github.com/spring-projects/spring-framework/commit/8d12d4d0c6e8499de8e48a4b66ae547d7a2cfb98)
  - [975a7f0](https://github.com/spring-projects/spring-framework/commit/975a7f0e4c15d21ca7a3acade5d7657ad9183be1)
  - [032a9c8](https://github.com/spring-projects/spring-framework/commit/032a9c8f38a68c8c1b305b496082f4a5c4f87121)
  - [49fd7c9](https://github.com/spring-projects/spring-framework/commit/49fd7c99ae6483b4878145bf79ae1fe93de74f7d)
  - [8ccf05a](https://github.com/spring-projects/spring-framework/commit/8ccf05adeefa3fd2a377eba067a156ea163dd616)
  - [dfbcaf3](https://github.com/spring-projects/spring-framework/commit/dfbcaf31dcbcd37d065db581fb62e8def726f389)
  - [1458d5f](https://github.com/spring-projects/spring-framework/commit/1458d5f39fef06d01348352fc67d5bc2cbe812e9)

## 内容

When running the `jdbc-tx` sample in `sb-3.0.x` branch from spring-native, it fails with:

```
java.lang.IllegalStateException: Failed to execute CommandLineRunner
        at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:769) ~[jdbc-tx:3.0.0-SNAPSHOT]
        at org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:750) ~[jdbc-tx:3.0.0-SNAPSHOT]
        at org.springframework.boot.SpringApplication.run(SpringApplication.java:318) ~[jdbc-tx:3.0.0-SNAPSHOT]
        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1301) ~[jdbc-tx:3.0.0-SNAPSHOT]
        at org.springframework.boot.SpringApplication.run(SpringApplication.java:1290) ~[jdbc-tx:3.0.0-SNAPSHOT]
        at app.main.SampleApplication.main(SampleApplication.java:23) ~[jdbc-tx:0.0.1.BUILD-SNAPSHOT]
Caused by: java.lang.IllegalArgumentException: Expected transaction
        at org.springframework.util.Assert.isTrue(Assert.java:121) ~[na:na]
        at app.main.Runner.run(Runner.java:53) ~[jdbc-tx:0.0.1.BUILD-SNAPSHOT]
        at org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:766) ~[jdbc-tx:3.0.0-SNAPSHOT]
        ... 5 common frames omitted
```

This is the run method:

```java
	@Override
	@Transactional
	public void run(String... args) throws Exception {
		Assert.isTrue(TransactionSynchronizationManager.isActualTransactionActive(), "Expected transaction");
		try {
			find(1L);
		}
		catch (EmptyResultDataAccessException e) {
			entities.update(ADD_FOO, 1L, "Hello");
		}
	}
```

I guess that `@Transactional` doesn't work in native-image.

## コメント

### コメント 1 by sdeleuze

**作成日**: 2022-06-28

Related to #28688.

### コメント 2 by sdeleuze

**作成日**: 2022-07-07

I have improved the support for `@Transactional` with [this commit](https://github.com/spring-projects/spring-framework/commit/0387d54607f371b7ff9e28dd8a89ec6203d3a09b) that makes `@Transactional` annotated with `@Reflective` and registers proxy hints for `SpringProxy` but the `jdbc-tx` sample [here](https://github.com/spring-projects-experimental/spring-native/tree/sb-3.0.x/samples/jdbc-tx) still fails when compiled as a native executable with `error creating bean with name 'userEndpoints': Unsatisfied dependency expressed through method 'userEndpoints' parameter 0: No qualifying bean of type 'app.main.Finder<app.main.model.Foo>' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {} error`, like if proxied beans can't be injected in native. Notice here we have `@Component public class Runner implements CommandLineRunner, Finder<Foo> { ... }` that needs to be injected in `@Bean public RouterFunction<?> userEndpoints(Finder<Foo> entities) { ... }`.This samples works correctly on JVM + AOT so this issue is native specific.

### コメント 3 by sdeleuze

**作成日**: 2022-07-07

As discussed with @sbrannen, we need to replace the `SpringProxyRuntimeHintsRegistrar` by an AOT processor that will register dynamically the required proxies like here `CommandLineRunner.class, Finder.class, SpringProxy.class, Advised.class, DecoratingProxy.class` + reflection entries for proxied interfaces with [declared methods](https://github.com/spring-projects/spring-framework/blob/main/spring-aop/src/main/java/org/springframework/aop/framework/JdkDynamicAopProxy.java#L136).

