# findAnnotationOnBeanが静的@Beanメソッドの囲んでいるクラスからアノテーションを見つける

**課題番号**: #28298

**状態**: closed | **作成者**: wilkinsona | **作成日**: 2022-04-07

**ラベル**: type: bug, in: core

**URL**: https://github.com/spring-projects/spring-framework/issues/28298

**関連リンク**:
- Commits:
  - [3da2b5c](https://github.com/spring-projects/spring-framework/commit/3da2b5c1b914a20f6728e614f51d8eb25d956c3d)
  - [a364410](https://github.com/spring-projects/spring-framework/commit/a36441064639eed2ed79986fce20f82ea8feef3a)
  - [a14650e](https://github.com/spring-projects/spring-framework/commit/a14650e0dc37ad36e0d1c1d8ebbb0440bcfd312b)
  - [a1fe05f](https://github.com/spring-projects/spring-framework/commit/a1fe05f40b02cc79dc3777ff6f90a04ac4de6eac)

## 内容

**影響バージョン:** 5.3.x

静的メソッドを使用してBeanが定義されている場合、`findAnnotationOnBean`は静的`@Bean`メソッドが属する`@Configuration`クラスからアノテーションを見つけます。`@Bean`メソッドが静的でない場合は、アノテーションが見つかりません。

以下のテストがこの動作を示しています：

```java
package com.example;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

import org.junit.jupiter.api.Test;

import org.springframework.context.annotation.AnnotationConfigApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import static org.assertj.core.api.Assertions.assertThat;

class FindAnnotationOnBeanTests {

    @Test
    void beanDefinedInInstanceMethodDoesNotHaveAnnotationsFromItsConfigurationClass() {
        beanDoesNotHaveAnnotationsFromItsConfigurationClass(InstanceBeanMethodConfiguration.class);
    }

    @Test
    void beanDefinedInStaticMethodDoesNotHaveAnnotationsFromItsConfigurationClass() {
        beanDoesNotHaveAnnotationsFromItsConfigurationClass(StaticBeanMethodConfiguration.class);
    }

    void beanDoesNotHaveAnnotationsFromItsConfigurationClass(Class<?> config) {
        try (AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(config)) {
            ExampleAnnotation annotation = context.getBeanFactory().findAnnotationOnBean("exampleBean",
                    ExampleAnnotation.class);
            assertThat(annotation).isNull();
        }
    }

    @Configuration
    @ExampleAnnotation
    static class StaticBeanMethodConfiguration {

        @Bean
        static String exampleBean() {
            return "example";
        }

    }

    @Configuration
    @ExampleAnnotation
    static class InstanceBeanMethodConfiguration {

        @Bean
        String exampleBean() {
            return "example";
        }

    }

    @Target(ElementType.TYPE)
    @Retention(RetentionPolicy.RUNTIME)
    static @interface ExampleAnnotation {

    }

}
```

`beanDefinedInInstanceMethodDoesNotHaveAnnotationsFromItsConfigurationClass`は成功しますが、`beanDefinedInStaticMethodDoesNotHaveAnnotationsFromItsConfigurationClass`は失敗します。

## コメント

### コメント 1 by 284831721

**作成日**: 2022-04-08

理解できないのですが、どちらのテスト結果が期待されているのでしょうか？最初か2番目か。

`findAnnotationOnBean`メソッドのコメントには次のように記載されているので、テスト1が期待される動作だと思うのですが、正しいでしょうか？

```
/**
	 * Find an {@link Annotation} of {@code annotationType} on the specified bean,
	 * traversing its interfaces and super classes if no annotation can be found on
	 * the given class itself, as well as checking the bean's factory method (if any).
	 * @param beanName the name of the bean to look for annotations on
	 * @param annotationType the type of annotation to look for
	 * (at class, interface or factory method level of the specified bean)
	 * @return the annotation of the given type if found, or {@code null} otherwise
	 * @throws NoSuchBeanDefinitionException if there is no bean with the given name
	 * @since 3.0
	 * @see #getBeanNamesForAnnotation
	 * @see #getBeansWithAnnotation
	 */

```

### コメント 2 by wilkinsona

**作成日**: 2022-04-08

両方とも成功するべきです。これらのテストは、静的Beanメソッドとインスタンスメソッドの間で説明された違いを示しています。
