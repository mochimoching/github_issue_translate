*このドキュメントは生成AI(Claude Sonnet 4.5)によって2026年1月6日に生成されました。*

## 課題概要

URLの末尾スラッシュマッチング機能を非推奨とし、デフォルト値を`true`（マッチする）から`false`（マッチしない）に変更するセキュリティとパスマッチング透明性の改善です。

**背景説明**:
- **末尾スラッシュマッチング**: `/users`と`/users/`を同じURLとして扱う機能
- **パスマッチング**: リクエストURLとコントローラーマッピングの照合処理
- **Spring Security**: 認可ルールを定義するセキュリティフレームワーク

**問題の詳細**:
従来、Spring MVCはデフォルトで末尾スラッシュの有無を区別せず、両方にマッチしていました：

```java
@GetMapping("/resources")  // "/resources" と "/resources/" 両方にマッチ
String resources() {
    return "Hello";
}
```

しかし、これがセキュリティ脆弱性を引き起こす可能性がありました：

```java
@RestController
public class SampleApplication {
    @GetMapping("/resources")
    String resources() {
        return "Hello from /resources";
    }
    
    @GetMapping("/resources/{id}")
    String resourceById(@PathVariable Long id) {
        return "Hello from /resources/" + id;
    }
    
    @Bean
    SecurityFilterChain filterChain(HttpSecurity httpSecurity) {
        return httpSecurity
            .authorizeHttpRequests(requests -> {
                requests.antMatchers("/resources").hasRole("admin");     // adminのみ
                requests.antMatchers("/resources/**").hasRole("user");   // userで可
            })
            .build();
    }
}
```

**セキュリティ問題**:
1. Spring Securityは`/resources`へのアクセスをadminに制限
2. Spring MVCは末尾スラッシュマッチングにより`/resources/`も同じハンドラーにルーティング
3. しかしSpring Securityの`antMatchers("/resources")`は`/resources/`にマッチしない
4. 結果：`/resources/**`ルール（userロール）が適用され、userロールで`/resources/`にアクセス可能
5. **認可のバイパスが発生** ✗

## 原因

Spring MVCとSpring Securityの間で、URLパスの解釈に不一致がありました：
- **Spring MVC**: デフォルトで末尾スラッシュを区別しない（曖昧）
- **Spring Security（antMatchers使用時）**: 末尾スラッシュを区別する

この曖昧さが、セキュリティ境界の誤解釈を招きやすい設計でした。

**副次的問題**:
- URLの手動入力時の利便性は限定的（APIでは不要）
- プロキシやフィルターとの組み合わせで予期しない動作
- 明示的でないパスマッチング動作

## 対応方針

以下のコミットで段階的に実装されました：

- [d96b4a0](https://github.com/spring-projects/spring-framework/commit/d96b4a046342a5d886eeb967c05f8b7f95b6dfb1): 基本的な非推奨化
- [4bff95a](https://github.com/spring-projects/spring-framework/commit/4bff95a18017b7a9f603315c606e8f31e74bd658): デフォルト値変更
- [0098f29](https://github.com/spring-projects/spring-framework/commit/0098f2931adaa919ddfe66eda2ef620036e7044a): RequestMappingHandlerMapping調整
- その他コミット: 関連する設定箇所の統一

**実装内容**:

1. **末尾スラッシュマッチングを非推奨化**:
```java
@Deprecated
public void setUseTrailingSlashMatch(boolean useTrailingSlashMatch) {
    // この設定は将来削除される
}
```

2. **デフォルト値を`false`に変更**:
```java
// 変更前
private boolean useTrailingSlashMatch = true;

// 変更後
private boolean useTrailingSlashMatch = false;
```

3. **影響範囲**:
- `RequestMappingHandlerMapping`（アノテーション付きコントローラー）
- `SimpleUrlHandlerMapping`（すでに`false`だったが統一のため非推奨化）
- その他すべてのハンドラーマッピング

**移行方法**:

従来の動作が必要な場合（推奨されない）：
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void configurePathMatch(PathMatchConfigurer configurer) {
        configurer.setUseTrailingSlashMatch(true);  // 非推奨
    }
}
```

**推奨される代替策**:
```java
// 方法1: 明示的に両方のマッピングを定義
@GetMapping({"/resources", "/resources/"})
String resources() { ... }

// 方法2: リダイレクト設定
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addViewControllers(ViewControllerRegistry registry) {
        registry.addRedirectViewController("/resources/", "/resources");
    }
}

// 方法3: プロキシレベルでのリダイレクト（最も推奨）
// nginx等で301リダイレクト設定
```

**メリット**:
- セキュリティ脆弱性の排除
- パスマッチングの明示性向上
- Spring MVCとSpring Securityの整合性
- より予測可能な動作

**注意事項**:
- Spring Boot 3.0で適用
- 既存アプリケーションで404エラーが発生する可能性
- [Spring Boot 3.0移行ガイド](https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.0-Migration-Guide#spring-mvc-and-webflux-url-matching-changes)に詳細記載

**関連する過去の変更**（一貫性のある方向性）:
- サフィックスパターンマッチングの非推奨（Spring 5.2/5.3）
- パスセグメントのトリミング動作変更
- パスのデコード方法の改善
