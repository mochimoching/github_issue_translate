*このドキュメントは生成AI(Claude Sonnet 4.5)によって2026年1月6日に生成されました。*

## 課題概要

Spring WebClientを使用してオブジェクトの`Flux`（ストリーム）をJSON形式でHTTPリクエストボディとして送信する際、メモリ効率の問題が発生するという機能強化要求です。

**背景説明**:
- **WebClient**: Spring WebFluxが提供するノンブロッキングなHTTPクライアント
- **Flux**: Project Reactorの非同期ストリーム型。複数の要素を順次発行します
- **Jackson2JsonEncoder**: オブジェクトをJSON形式にエンコードするコーデック

**問題の詳細**:
現在の実装では、`Flux`をJSON（`application/json`）として送信する際、`Jackson2JsonEncoder`が内部で`collectList()`を呼び出し、すべての要素をメモリ上のリストに収集してからシリアライズします。これにより：
- 数百万の要素を持つ`Flux`の場合、メモリ不足（OutOfMemoryError）が発生する可能性
- リアクティブストリーミングの利点（バックプレッシャー、メモリ効率）が失われる

要望は、要素が利用可能になった時点で順次JSON配列としてストリーミング書き込みできるようにすることです。

## 原因

`Jackson2JsonEncoder`のデフォルト動作が、通常のJSONコンテンツタイプ（`application/json`）に対してバッチ処理（全要素収集）を行うように設計されているため。

これは、個別書き込みよりも一括書き込みの方がパフォーマンスが良いという判断に基づいています。ストリーミング動作はNDJSON（Newline Delimited JSON）のような特定のMIMEタイプでのみデフォルトで有効になっています。

## 対応方針

[ce56846](https://github.com/spring-projects/spring-framework/commit/ce568468aed09147e335b5d5a717e1b2dac581a8)のコミットで対応されました。

**解決方法**:
`Jackson2JsonEncoder`の`streamingMediaTypes`プロパティを設定することで、`application/json`でもストリーミング動作を有効化できるようになりました：

```java
WebClient webClient = WebClient.builder()
    .codecs(configurer -> {
        Jackson2JsonEncoder encoder = new Jackson2JsonEncoder();
        encoder.setStreamingMediaTypes(List.of(MediaType.APPLICATION_JSON));
        configurer.defaultCodecs().jackson2JsonEncoder(encoder);
    })
    .build();
```

この設定により：
1. `Flux`の要素を利用可能になった時点で順次JSON配列として書き込み
2. メモリ上でリスト化せずにストリーミング処理
3. `[`と`]`で配列をラップし、要素間にカンマを自動挿入

参考: [リファレンスドキュメント - コーデックのデフォルト設定変更方法](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-config-message-codecs)
