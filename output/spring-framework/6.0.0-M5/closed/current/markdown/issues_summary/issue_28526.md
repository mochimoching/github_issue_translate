*このドキュメントは生成AI(Claude Sonnet 4.5)によって2026年1月6日に生成されました。*

## 課題概要

`BeanRegistrationAotProcessor`インターフェースを実装するBean自体が、AOT処理の対象から暗黙的に除外される動作を、オプションで制御できるようにする改善です。

**背景説明**:
- **BeanRegistrationAotProcessor**: AOT（Ahead-Of-Time）コンパイル時に、Beanの登録をカスタマイズ処理するインターフェース
- **AOT処理**: アプリケーション起動前に、Beanの登録コードを事前生成する仕組み
- **暗黙的除外**: 自動的にAOT処理の対象外にすること

**問題の詳細**:
`BeanDefinitionMethodGeneratorFactory`の`isImplicitlyExcluded`メソッドは、`BeanRegistrationAotProcessor`を実装するBean自体を常に除外します：

```java
// AOTプロセッサーの例
@Component
public class CustomAotProcessor implements BeanRegistrationAotProcessor {
    @Override
    public BeanRegistrationAotContribution processAheadOfTime(
            RegisteredBean registeredBean) {
        // 他のBeanの処理をカスタマイズ
        return ...;
    }
}

// 問題: このCustomAotProcessor自身も暗黙的に除外される
// → AOT生成コードに含まれない
// → ネイティブイメージで実行時にBeanとして利用できない
```

**要件**:
Spring Bootでは、以下のようなケースが想定されます：
- AOTプロセッサーとして動作しつつ、ランタイムでもBeanとして必要
- AOT処理では他のBeanをカスタマイズするが、自身は通常のBeanとして登録されるべき
- 除外するかどうかをプロセッサー自身が制御したい

## 原因

`BeanDefinitionMethodGeneratorFactory`の設計が、AOTプロセッサーBeanは必ず除外すべきという前提に基づいていました。

しかし実際には、以下の2種類のプロセッサーが存在します：
1. **除外すべきプロセッサー**: AOT処理時のみ必要で、ランタイムでは不要
2. **除外すべきでないプロセッサー**: AOT処理後もランタイムでBeanとして必要

この区別ができる仕組みがありませんでした。

## 対応方針

[6f71328](https://github.com/spring-projects/spring-framework/commit/6f71328ba6f8d2d6d001cf26f24459852ee5dd8f)のコミットで実装されました。

**実装内容**:

`BeanRegistrationExcludeFilter`の実装有無で除外動作を制御できるように変更：

```java
// パターン1: 除外されるプロセッサー（従来通り）
@Component
public class BuildTimeOnlyProcessor implements BeanRegistrationAotProcessor {
    // BeanRegistrationExcludeFilterを実装していない
    // → 暗黙的に除外される（AOT処理時のみ使用）
    @Override
    public BeanRegistrationAotContribution processAheadOfTime(...) {
        return ...;
    }
}

// パターン2: 除外されないプロセッサー（新機能）
@Component
public class RuntimeNeededProcessor 
        implements BeanRegistrationAotProcessor, 
                   BeanRegistrationExcludeFilter {
    // BeanRegistrationExcludeFilterを実装
    // → 自分自身のフィルタリングを制御できる信号
    // → 暗黙的な除外は行われない
    
    @Override
    public BeanRegistrationAotContribution processAheadOfTime(...) {
        return ...;
    }
    
    @Override
    public boolean isExcluded(RegisteredBean registeredBean) {
        // 他のBeanを除外するかどうかの判定
        return ...;
    }
}
```

**動作ロジック**:
```
BeanRegistrationAotProcessorを実装している?
├─ YES
│  └─ BeanRegistrationExcludeFilterも実装している?
│     ├─ YES → 暗黙的除外なし（自分で制御）
│     └─ NO  → 暗黙的に除外される
└─ NO → 通常のBean（除外されない）
```

**メリット**:
- AOTプロセッサーの柔軟な制御が可能
- ランタイムでも必要なプロセッサーをBeanとして登録可能
- Spring Bootの自動設定での利用が容易に
- 既存の動作は維持（後方互換性）

**注意点**:
- この改善は一時的な解決策として認識されている
- より良い設計（`AotProcessor`のデフォルトメソッドなど）が将来検討される可能性がある
