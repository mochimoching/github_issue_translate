*このドキュメントは生成AI(Claude Sonnet 4.5)によって2026年1月6日に生成されました。*

## 課題概要

Kotlin RouterFunction DSLに、属性（attributes）サポートを追加する機能強化です。Javaビルダーでは既にサポートされていましたが、Kotlin DSLでは利用できませんでした。

**背景説明**:
- **RouterFunction**: Spring WebFluxとSpring Web MVCで、関数型スタイルでルーティングを定義する仕組み
- **Kotlin DSL**: KotlinでRouterFunctionを簡潔に記述するためのドメイン固有言語
- **属性（attributes）**: ルーティングにメタデータを付与する仕組み（例: セキュリティ設定、ロギング、OpenAPI仕様）

**問題の詳細**:
Javaビルダーでは属性を設定可能：
```java
// Javaでの属性サポート（5.3.19時点）
RouterFunctions.route()
    .GET("/users", handler::getUsers)
        .withAttribute("security", "admin")      // ✅ 使用可能
        .withAttribute("rateLimit", "100/hour")  // ✅ 使用可能
    .build();
```

しかし、Kotlin DSLでは利用不可：
```kotlin
// Kotlin DSLでの試み（5.3.19時点）
router {
    GET("/users", handler::getUsers)
    // withAttribute() が存在しない ❌
}
```

**要望**:
```kotlin
// 期待される使用方法
router {
    GET("/users", handler::getUsers) {
        attribute("security", "admin")
        attribute("rateLimit", "100/hour")
    }
}
```

## 原因

Kotlin RouterFunction DSLの設計時に、属性サポートが考慮されていませんでした。

Javaビルダーには以下のメソッドが存在：
- `withAttribute(String name, Object value)`
- `withAttributes(Consumer<Map<String, Object>>)`

しかし、これらに対応するKotlin DSL拡張関数が実装されていませんでした。

影響範囲：
- WebFlux: `RouterFunctionDsl`, `CoRouterFunctionDsl`
- WebMVC: `RouterFunctionDsl`

## 対応方針

以下のコミットで実装されました：

- [cc17178](https://github.com/spring-projects/spring-framework/commit/cc1717871f4475459cebc1f39d5167a7af43abb5): WebFlux DSL対応
- [bbabf8d](https://github.com/spring-projects/spring-framework/commit/bbabf8d855cc8d48757bdc86f2f2c426a7438f0a): WebMVC DSL対応
- [283bc9e](https://github.com/spring-projects/spring-framework/commit/283bc9ede936bd41b68ad2ee7fe00047d5550b93): CoRouter DSL対応

**実装内容**:

Kotlin DSLに属性設定用のメソッドを追加：

```kotlin
// RouterFunctionDsl拡張 (WebFlux/WebMVC)
fun RouterFunctionDsl.GET(
    pattern: String, 
    handler: HandlerFunction<ServerResponse>,
    attributesConfigurer: AttributesConfigurer.() -> Unit = {}
) {
    // 属性設定をサポート
}

class AttributesConfigurer {
    fun attribute(name: String, value: Any) { ... }
    fun attributes(block: MutableMap<String, Any>.() -> Unit) { ... }
}
```

**使用例**:

**基本的な属性設定**:
```kotlin
// WebFlux
router {
    GET("/api/users", userHandler::list) {
        attribute("security", "authenticated")
        attribute("rateLimit", "100/hour")
    }
    
    POST("/api/users", userHandler::create) {
        attribute("security", "admin")
        attribute("audit", true)
    }
}

// WebMVC (同じ構文)
router {
    GET("/users/{id}", userHandler::getUser) {
        attribute("cacheControl", "max-age=3600")
    }
}
```

**複数属性の設定**:
```kotlin
router {
    GET("/api/reports", reportHandler::generate) {
        attributes {
            put("security", "admin")
            put("timeout", Duration.ofMinutes(5))
            put("priority", "high")
        }
    }
}
```

**Coroutine対応（CoRouterFunctionDsl）**:
```kotlin
coRouter {
    GET("/suspend/users") { request ->
        attribute("async", true)
        // suspending handler
        val users = userRepository.findAllSuspend()
        ServerResponse.ok().bodyValueAndAwait(users)
    }
}
```

**属性の活用例（セキュリティ）**:
```kotlin
router {
    // パブリックエンドポイント
    GET("/public/info", infoHandler::getPublicInfo)
    
    // 認証が必要
    GET("/protected/data", dataHandler::getData) {
        attribute("security", "authenticated")
    }
    
    // 管理者のみ
    POST("/admin/config", adminHandler::updateConfig) {
        attribute("security", "admin")
        attribute("audit", true)
    }
}

// フィルターで属性をチェック
fun securityFilter(request: ServerRequest, next: HandlerFunction): Mono<ServerResponse> {
    val securityLevel = request.attributes()["security"] as? String
    return when (securityLevel) {
        "admin" -> checkAdminRole().then(next.handle(request))
        "authenticated" -> checkAuthenticated().then(next.handle(request))
        else -> next.handle(request)
    }
}
```

**OpenAPI統合での使用**:
```kotlin
router {
    GET("/api/users", userHandler::list) {
        attribute("openapi.operationId", "listUsers")
        attribute("openapi.summary", "List all users")
        attribute("openapi.tags", listOf("users"))
    }
}
```

**メリット**:
- KotlinでもJavaと同等の機能
- 関数型ルーティングでのメタデータ管理
- セキュリティ、キャッシング、OpenAPI統合が容易
- Kotlin DSLの一貫性向上
- WebFlux、WebMVC、Coroutineすべてに対応
