# createExceptionでエラー終了するMonoを返すメソッドをClientResponseに追加

**Issue番号**: [#27637](https://github.com/spring-projects/spring-framework/issues/27637)

**状態**: closed | **作成者**: jwChung | **作成日**: 2021-11-04

**ラベル**: in: web, type: enhancement, status: feedback-provided

**URL**: https://github.com/spring-projects/spring-framework/issues/27637

**関連リンク**:
- Commits:
  - [7794606](https://github.com/spring-projects/spring-framework/commit/7794606305da37e5efbfeded67eb421208492339)

## 内容

[メソッド`ClientResponse.createException()`は`Mono<WebClientResponseException>`型を返します。](https://github.com/spring-projects/spring-framework/blob/main/spring-webflux/src/main/java/org/springframework/web/reactive/function/client/ClientResponse.java#L182) `Mono<Exception>`は`Either<Exception, Exception>`のように感じられます。実際に必要なのは`Mono<RESULT>`型だと思います。そこで、`ClientResponse`インターフェースに`Mono<RESULT>`型を返す`createError`メソッドがあったらどうでしょうか?

## コメント

### コメント 1 by poutsma

**作成日**: 2021-11-19

異なる例外を持つことのメリットは理解できますが、`WebClientResponseException`を希望する型に`map`することはできませんか?

### コメント 2 by jwChung

**作成日**: 2021-11-26

@poutsma それには`Mono<T>.onErrorMap/onErrorResume`を使うのではないでしょうか?

多くの場合、`createException()`の戻り値は次のように`Mono<RESULT>`に変換されます。

```java
Mono<RESULT> mono = clientResponse.createException().flatMap(e -> Mono.error(new MyException("message", e)));
```

次のように書けたら良いと思います。

```java
Mono<RESULT> mono = clientResponse.createError().onErrorMap(e -> new MyException("message", e));
```

### コメント 3 by rstoyanchev

**作成日**: 2021-11-30

[#27645](https://github.com/spring-projects/spring-framework/issues/27645)に例外を変更しない関連する例があります。`exchangeToMono`と`exchangeToFlux`から`createException`を使用する場合、ドキュメントでは`Mono.error(response.createException())`を返すと記載していますが、実際には`response.createException().flatMap(Mono::error)`が必要で、これは結果のジェネリック型に一致させるためだけです。`response.createException().cast(...)`でも可能ですが、いずれにせよ不便です。

`createException`を`Mono#error`と同様に、任意の型にキャストできるようにすることは理にかなっています。結局のところ、エラーシグナルは型`T`から`Exception`に切り替わるため、これは予想されることです。@poutsma どう思いますか?

### コメント 4 by poutsma

**作成日**: 2021-12-01

個人的には、ジェネリック型ではなく`Mono<WebClientResponseException>`戻り型が提供する明示性を好みます。後者の場合、メソッドが何をするかを確認するには、事実上javadocを読む必要がありますが、前者の場合はそうではありません。これは`createException`から期待される動作とほぼ一致します。

とはいえ、[#27645](https://github.com/spring-projects/spring-framework/issues/27645)を見ると、現在のシグネチャも理想的ではなく、`flatMap`の使用が必要で、それが明確ではないことに気づきます。`createException`と`createError`の両方を持つことに反対する理由はないため、追加します。
