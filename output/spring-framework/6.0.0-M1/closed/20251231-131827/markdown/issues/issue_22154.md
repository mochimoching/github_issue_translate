# @RequestMapping without @Controller registered as handler [SPR-17622]

**Issue番号**: #22154

**状態**: closed | **作成者**: spring-projects-issues | **作成日**: 2018-12-23

**ラベル**: in: web, type: enhancement

**URL**: https://github.com/spring-projects/spring-framework/issues/22154

**関連リンク**:
- Commits:
  - [da2bcd8](https://github.com/spring-projects/spring-framework/commit/da2bcd837d58b03e3f696572d656153ee312521c)
  - [93bc27c](https://github.com/spring-projects/spring-framework/commit/93bc27cf2330e07f91a97b2934a0a0ef218cb928)
  - [b0fc461](https://github.com/spring-projects/spring-framework/commit/b0fc46113b4a93d532f56574571005ee3b47afaf)
  - [3bed306](https://github.com/spring-projects/spring-framework/commit/3bed306d1834465c0ea380c188bf9a320c06bc11)
  - [1d82544](https://github.com/spring-projects/spring-framework/commit/1d825440c328ef90b940ba6be8483aec184daeb4)
  - [a6b628a](https://github.com/spring-projects/spring-framework/commit/a6b628ab9a8d712e9aa06e7cb5cd6823d10daa1b)
  - [a791f13](https://github.com/spring-projects/spring-framework/commit/a791f13700da04f1f3fea4e9b2b64570f68d033b)
  - [eee4dd9](https://github.com/spring-projects/spring-framework/commit/eee4dd9f14954bb6fdc6b3198b3fe71c0c34ab3b)
  - [26c5968](https://github.com/spring-projects/spring-framework/commit/26c59681ad8e05cb65d573ca389269cccd13150d)
  - [3600644](https://github.com/spring-projects/spring-framework/commit/3600644ed1776dce35c4a42d74799a90b90e359e)
  - [32b8710](https://github.com/spring-projects/spring-framework/commit/32b87104892bc5d551947af125104b350d00a80b)
  - [436d71d](https://github.com/spring-projects/spring-framework/commit/436d71d01e89fe07508a9fb6b02960bb4acff200)
  - [d87fcfa](https://github.com/spring-projects/spring-framework/commit/d87fcfaf3eb403bb58ec4d71ce329fbbc32c2e00)
  - [18c8d14](https://github.com/spring-projects/spring-framework/commit/18c8d146d88cd00959b69b1071a96ff5496e01dd)

## 内容

**[Eugene Tenkaev](https://jira.spring.io/secure/ViewProfile.jspa?name=hronom)** opened **[SPR-17622](https://jira.spring.io/browse/SPR-17622?redirect=false)** and commented

Following this approach here http://projects.spring.io/spring-cloud/spring-cloud.html#spring-cloud-feign-inheritance

If you add root `@RequestMapping` to the `UserService` it will be registered as handler in Spring MVC application.

Example project to reproduce here https://github.com/Hronom/test-shared-mapping-interface

Related discussions:
* https://github.com/spring-cloud/spring-cloud-netflix/issues/466
* https://stackoverflow.com/questions/29284911/can-a-spring-cloud-feign-client-share-interface-with-an-spring-web-controller

To handle this properly need to avoid registration of controller that has only `@RequestMapping` annotation.

Proposed solution:
Register handler only if it has annotation `@Controller` or `@RestController`.

---

**Affects:** 5.1.3

**Issue Links:**
- #16747 Introduce proxy-based REST client similar to HttpInvokerProxyFactoryBean

1 votes, 3 watchers


## コメント

### コメント 1 by spring-projects-issues

**作成日**: 2018-12-24

**[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze)** commented

I understand the rationale behind what you ask, but class level `@Component` + `@RequestMapping` is supported for a long time, so removing that support would break a lot of applications.

[Rossen Stoyanchev](https://jira.spring.io/secure/ViewProfile.jspa?name=rstoya05-aop) [Arjen Poutsma](https://jira.spring.io/secure/ViewProfile.jspa?name=arjen.poutsma) Could you share your point of view on this change request?


### コメント 2 by spring-projects-issues

**作成日**: 2018-12-24

**[Eugene Tenkaev](https://jira.spring.io/secure/ViewProfile.jspa?name=hronom)** commented

[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze) I have edit description the idea is next:
Make Spring MVC register endpoint **only if** it has `@Controller` or `@RestController` on the class level.

My example shows that:
Right now, if class has only `@RequestMapping` - this class will be registered as the endpoint in Spring MVC.


### コメント 3 by spring-projects-issues

**作成日**: 2018-12-25

**[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze)** commented

I understand, but what I wanted to clarify is that `@RequestMapping` alone does not expose endpoints automatically, but beans with class level `@RequestMapping` annotations does and this is used by developers in various ways, one of these ways being my `@Component` + `@RequestMapping` example.

`@FeignClient` itself is not meta annotated with `@Component`, but I guess it is registered as a bean by `FeignClientFactoryBean` (I have not verified) which is from Spring Framework POV similar to `@Component` + `@RequestMapping` or programmatic bean registration of classes annotated by `@RequestMapping`.

I understand your request for being more restrictive in how we identify REST endpoints, and the issue raised for `@FeignClient` could apply for #16747. But I am also concern by such breaking change, that's why I am asking Rossen and Arjen feedback who have more knowledge and context than me on that topic.


### コメント 4 by rstoyanchev

**作成日**: 2019-01-18

Class level `@RequestMapping` is used as a hint, independent of `@Controller`, because `@RequestMapping` can be used on an interface, in which case the controller can be an AOP proxy and the `@Controller` annotation is not accessible to Spring MVC through the proxy.

@jhoeller do you see any options to refine the checks, e.g. if type-level `@RequestMapping` is found without `@Controller` and the bean is a proxy, then introspect further to see if we can find the `@Controller` annotation? 

Note also that Spring Data REST has a similar situation for REST endpoints, and it [solves that through](https://docs.spring.io/spring-data/rest/docs/3.1.4.RELEASE/reference/html/#_repositoryresthandlermapping) an additional `RequestMappingHandlerMapping` instance ordered earlier + a special stereotype to identify such endpoints, which works but is probably more involved than it needs to be. We could also try and suppress Spring MVC from treating certain types (based on some criteria) as controllers but again that doesn't seem ideal and requires extra config.



### コメント 5 by remal

**作成日**: 2019-07-05

This issue leads to a lot of different problems that are very hard to debug. Please fix it. I can suggest these solutions:
1. Do not treat classes annotated by `@RequestMapping` as handlers. Only `@Controller` annotation should be taken into consideration.
1. Spring Data has `@NoRepositoryBean`. A similar annotation can be created for request handlers. For example: `@NoRequestHandler`.
    * In this case `@FeignClient` annotation can be annotated by this `@NoRequestHandler` annotation.

I'd suggest implementing the first solution.

### コメント 6 by TannnnnnnnnnnnnnnnK

**作成日**: 2020-04-16

regist handler and regist requestmapping
two different things, should be separate from each other, even they are related

### コメント 7 by glockbender

**作成日**: 2020-06-16

This issue is still relevant. Any progress with that?

### コメント 8 by odrotbohm

**作成日**: 2020-07-14

Copying the description of #25386 here for reference:

**tl;dr** – The current behavior is problematic for folks trying to customize Spring Data REST using custom controllers, too, as it subtley makes controllers using `@RequestMapping` on the type level end up in the wrong handler mapping

Rossen mentioned that [here](https://github.com/spring-projects/spring-framework/issues/22154#issuecomment-455561279) already, but it just recently came up in StackOverflow questions again.

> `RequestMappingHandlerMapping.isHandler(…)` not only picks up types annotated with `@Controller` but also ones that are annotated with `@RequestMapping` on the type level. This is problematic in cases in which other `HandlerMapping` instances are registered that might be supposed to handle those controllers.
>
> A prominent example of this is Spring Data REST, which registers a dedicated mapping to expose HTTP resources for Spring Data repositories. Users can selectively override those resources by declaring a controller themselves and just declare a handler method for e.g. the URI of an item resource and an HTTP verb of choice. If that controller now declares an `@RequestMapping` on the type level, the Spring MVC registered one will pick up that class, and not see any other mappings defined for the same URI pattern but exposing support for other HTTP methods potentially available in subsequent `HanderMapping` implementations.
> 
> This is a pretty common error scenario reported by users (see [this StackOverflow](https://stackoverflow.com/questions/62865947/restrepositorycontroller-hide-rest-repository-endpoints/62877864) question for example). It's also pretty hard to explain to users as it involves talking about quite a few implementation details.
>
> Removing the explicit handling of `@RequestMapping` on the type level bears the risk that controller implementations not also being annotated with `@Controller` would not be picked up automatically anymore. I haven't found any Spring MVC related documentation that actually shows an example of code not using the annotations in combination when used at the type level. A fix for that issue would be to also annotate the affected controller type with `@Controller`. I can see this being suboptimal for a release in a minor version but for 6.0 we should at least reevaluate.

### コメント 9 by mothinx

**作成日**: 2020-11-12

Just get this issue with a feign client and spent a lot of hours to locate it. Is someone on that issue ?

### コメント 10 by odrotbohm

**作成日**: 2020-12-18

This just came up in yet another Spring Data REST issue: https://jira.spring.io/browse/DATAREST-1591.

### コメント 11 by rstoyanchev

**作成日**: 2021-10-06

**Team Decision:** after some cross-team discussions, for the short term the issue will be addressed on the side of Spring Data REST and Spring Cloud.

For Spring Framework 6.0, we will also address this in the Spring Framework by no longer considering a class with a type-level `@RequestMapping` as a candidate for detection, unless there is also `@Controller`. 


### コメント 12 by remal

**作成日**: 2021-10-06

@rstoyanchev do you know if there is a corresponding ticket in Spring Cloud that can be subscribed to?

### コメント 13 by rstoyanchev

**作成日**: 2021-10-14

@remal, yes you can follow here https://github.com/spring-cloud/spring-cloud-openfeign/issues/547.

### コメント 14 by OrangeDog

**作成日**: 2024-01-23

Just to note that the previous behaviour allowed declaring and constructing the controller with a `@Bean` method. Now that you have to add `@Controller` to the class, they are automatically declared by `@ComponentScan`, which will now need additional exclusion filters.

