# Unable to use WebTestClient with mock server in Kotlin

**Issue番号**: #20606

**状態**: closed | **作成者**: spring-projects-issues | **作成日**: 2017-10-10

**ラベル**: in: test, type: task

**URL**: https://github.com/spring-projects/spring-framework/issues/20606

**関連リンク**:
- Commits:
  - [dc5a21f](https://github.com/spring-projects/spring-framework/commit/dc5a21fbd1d59a573b7385cdeb92d3bc103672a1)

## 内容

**[Daniel Jones](https://jira.spring.io/secure/ViewProfile.jspa?name=jonesd9)** opened **[SPR-16057](https://jira.spring.io/browse/SPR-16057?redirect=false)** and commented

I'm trying to set up a Kotlin/Spring project using Spring Boot 2.0.0.M4 and Spring Framework 5.0.0.M4 and have ran into trouble with `WebTestClient` in a mocked-server test.

Essentially the following in Java works fine:

```java
class JavaHelper {
    static WebTestClient getMockWebTestClient(ApplicationContext ctx) {
        return WebTestClient.bindToApplicationContext(ctx)
                            .apply(springSecurity())
                            .configureClient()
                            .filter(basicAuthentication())
                            .build();
    }
}
```

But Kotlin is unable to infer the type T of apply method:

```java
<T extends B> T apply(MockServerConfigurer configurer)
```

With the following code:

```java
WebTestClient.bindToApplicationContext(context)
                .apply(springSecurity())
                .configureClient()
                .filter(basicAuthentication())
                .build()
```

The problem is to do with the generic typings, I'm still fairly new to Kotlin but if I write my test using the same package as `ApplicationContextSpec` (since they're package-private) and do the following, it works as expected:

```java
(WebTestClient.bindToApplicationContext(context) as ApplicationContextSpec)
                .apply<ApplicationContextSpec>(springSecurity())
                .configureClient()
                .filter(basicAuthentication())
                .build()
```

I think the following:

```java
static MockServerSpec<?> bindToApplicationContext(ApplicationContext applicationContext) {
    return new ApplicationContextSpec(applicationContext);
}
```

should be changed to return `ApplicationContextSpec` (or at least `AbstractMockServerSpec<ApplicationContextSpec>`):

and make the class `ApplicationContextSpec` public. The constructor can still be default visibility so users won't be able to misuse the class outside of the defined API, and users in Kotlin will be able to import it for type inference.

---

**Affects:** 5.0 GA

**Issue Links:**
- #20945 Upgrade to Kotlin 1.3 (_**"depends on"**_)
- #20251 Kotlin unable to inherit type for WebTestClient#BodySpec

**Referenced from:** commits https://github.com/spring-projects/spring-framework/commit/b9a0e6bbf2b6fe5f0ed222f506efc644d0d9a4f0

2 votes, 11 watchers


## コメント

### コメント 1 by spring-projects-issues

**作成日**: 2017-10-10

**[Daniel Jones](https://jira.spring.io/secure/ViewProfile.jspa?name=jonesd9)** commented

I've added a test repo here:

https://github.com/dan-j/kotlin-reactive-test-SPR-16057


### コメント 2 by spring-projects-issues

**作成日**: 2017-10-27

**[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze)** commented

I think this is similar to #20251 which was expected to be fixed in Kotlin 1.2 via [KT-5464](https://youtrack.jetbrains.com/issue/KT-5464) and similar to what [Rob Winch](https://jira.spring.io/secure/ViewProfile.jspa?name=rwinch) raised as well, but was sadly postponed to Kotlin 1.3. As reported to JetBrains, this pending issue on Kotlin side makes `WebTestClient` not usable at all with Kotlin, and I have no other workaround to propose than using `WebClient` with non-mocked server for now, Reactor and Spring Kotlin extensions making that quite usable as demonstrated on this [example](https://github.com/sdeleuze/spring-kotlin-deepdive/blob/248c1c89cf5a7a4293adbace296d945637ed0d20/src/test/kotlin/io/spring/deepdive/PostJsonApiTests.kt).

For now I am going to update `WebTestClient` Javadoc to add a warning and a link to JetBrains issue + update our reference documentation with these infos. We will mark this issue as resolved asap we have the confirmation Kotlin 1.3 fixes this issue and our documentation has been updated to specify Kotlin 1.3+ should be used for `WebTestCient`.


### コメント 3 by spring-projects-issues

**作成日**: 2018-04-17

**[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze)** commented

Notice that #20251 is now fixed.


### コメント 4 by andriipivovarov

**作成日**: 2020-03-13

Any work around?

### コメント 5 by noah-iam

**作成日**: 2020-06-25

Hey,
For the similar issue , I want to share you my piece of code that is giving me same error :

.webFilter<>(myfilter) . This is saying to give the generic type here.

Error : Type expected

val client: WebTestClient = WebTestClient.bindToWebHandler { Mono.empty() } .webFilter<>(myfilter) .build()

Error : Type argument is not within its bounds. Expected: Nothing! Found: WebFilter!

@sdeleuze can you help me in this 

### コメント 6 by maresja1

**作成日**: 2020-10-19

@andriipivovarov Work around:

You have to re-define class MutatorFilter (it is a private static class in `SecurityMockServerConfigurers`):

```kotlin
// copy of org.springframework.security.test.web.reactive.server.SecurityMockServerConfigurers.MutatorFilter
internal class MutatorFilter : WebFilter {

    override fun filter(exchange: ServerWebExchange, webFilterChain: WebFilterChain): Mono<Void> {
        val context = exchange.getAttribute<Supplier<Mono<SecurityContext>>>(ATTRIBUTE_NAME)
        if (context != null) {
            exchange.attributes.remove(ATTRIBUTE_NAME)
            return webFilterChain.filter(exchange)
                .subscriberContext(ReactiveSecurityContextHolder.withSecurityContext(context.get()))
        }
        return webFilterChain.filter(exchange)
    }

    companion object {
        const val ATTRIBUTE_NAME = "context"
    }
}
```

And apply:

```kotlin
        WebTestClient.bindToApplicationContext(context)
            .configureClient()
            .baseUrl("https://api.example.com")
            .defaultHeader("Content-Type", MediaType.APPLICATION_JSON_VALUE)
// ...
            .apply { _, httpHandlerBuilder, _ ->
                httpHandlerBuilder?.filters { filters -> filters.add(0, MutatorFilter()) }
            }
```

If anyone knows about a better way, please let me know.

### コメント 7 by sdeleuze

**作成日**: 2020-10-27

This issue still happens with Kotlin 1.4.10 likely due to [KT-40804](https://youtrack.jetbrains.com/issue/KT-40804) and I agree we should try to find a solution. I am discussing that with Kotlin team.

### コメント 8 by xetra11

**作成日**: 2021-02-04

Any updates on this?

### コメント 9 by sdeleuze

**作成日**: 2021-03-25

Both Kotlin and Spring team agreed this issue should be fixed on Kotlin side. My current hope is that it will be fixed in Kotlin 1.6 (Kotlin 1.5 is just around the corner and Kotlin has now a 6 month release cycle so that won't be too far away).

### コメント 10 by petukhovv

**作成日**: 2021-08-03

Note that we (Kotlin team) supported given cases in the experimental mode in 1.5.30. In 1.5.30 the `-Xself-upper-bound-inference` compiler flag could be used to enabled the corresponding feature.
More information: https://youtrack.jetbrains.com/issue/KT-40804

### コメント 11 by sdeleuze

**作成日**: 2021-09-07

Indeed seems to work based on my tests, thanks! I will close this issue when we will be based on Kotlin 1.6 in order to add proper test.

@petrukhnov Could you please confirm this will be the default as of Kotlin 1.6?

### コメント 12 by petukhovv

**作成日**: 2021-09-07

Yes, it's going to be enabled by default since 1.6.

### コメント 13 by sdeleuze

**作成日**: 2021-10-29

Depends on #27413.

