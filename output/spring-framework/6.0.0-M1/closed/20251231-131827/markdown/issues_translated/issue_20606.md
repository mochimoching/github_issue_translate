# KotlinでWebTestClientをモックサーバーと共に使用できない

**Issue番号**: [#20606](https://github.com/spring-projects/spring-framework/issues/20606)

**状態**: closed | **作成者**: spring-projects-issues | **作成日**: 2017-10-10

**ラベル**: in: test, type: task

**URL**: https://github.com/spring-projects/spring-framework/issues/20606

**関連リンク**:
- Commits:
  - [dc5a21f](https://github.com/spring-projects/spring-framework/commit/dc5a21fbd1d59a573b7385cdeb92d3bc103672a1)

## 内容

**[Daniel Jones](https://jira.spring.io/secure/ViewProfile.jspa?name=jonesd9)** が **[SPR-16057](https://jira.spring.io/browse/SPR-16057?redirect=false)** を作成しコメント:

Spring Boot 2.0.0.M4とSpring Framework 5.0.0.M4を使用したKotlin/Springプロジェクトをセットアップしようとしていますが、モックサーバーテストで`WebTestClient`に問題が発生しました。

基本的に、Javaでは以下のコードは正常に動作します:

```java
class JavaHelper {
    static WebTestClient getMockWebTestClient(ApplicationContext ctx) {
        return WebTestClient.bindToApplicationContext(ctx)
                            .apply(springSecurity())
                            .configureClient()
                            .filter(basicAuthentication())
                            .build();
    }
}
```

しかし、Kotlinではapplyメソッドの型Tを推論できません:

```java
<T extends B> T apply(MockServerConfigurer configurer)
```

以下のコードで:

```java
WebTestClient.bindToApplicationContext(context)
                .apply(springSecurity())
                .configureClient()
                .filter(basicAuthentication())
                .build()
```

問題はジェネリック型に関するものです。私はまだKotlinに不慣れですが、`ApplicationContextSpec`と同じパッケージを使用してテストを作成し(パッケージプライベートなので)、以下のようにすると期待通りに動作します:

```java
(WebTestClient.bindToApplicationContext(context) as ApplicationContextSpec)
                .apply<ApplicationContextSpec>(springSecurity())
                .configureClient()
                .filter(basicAuthentication())
                .build()
```

以下のコード:

```java
static MockServerSpec<?> bindToApplicationContext(ApplicationContext applicationContext) {
    return new ApplicationContextSpec(applicationContext);
}
```

を`ApplicationContextSpec`を返すように変更すべきだと思います(または少なくとも`AbstractMockServerSpec<ApplicationContextSpec>`):

そして、クラス`ApplicationContextSpec`をpublicにします。コンストラクタはデフォルトの可視性のままでも良いので、ユーザーが定義されたAPI外でクラスを誤用することはありませんし、Kotlinのユーザーは型推論のためにインポートできるようになります。

---

**影響バージョン:** 5.0 GA

**関連Issue:**
- [#20945](https://github.com/spring-projects/spring-framework/issues/20945) Kotlin 1.3へのアップグレード (_**"依存している"**_)
- [#20251](https://github.com/spring-projects/spring-framework/issues/20251) KotlinがWebTestClient#BodySpecの型を継承できない

**参照元:** commits https://github.com/spring-projects/spring-framework/commit/b9a0e6bbf2b6fe5f0ed222f506efc644d0d9a4f0

投票数: 2, ウォッチャー: 11


## コメント

### コメント 1 by spring-projects-issues

**作成日**: 2017-10-10

**[Daniel Jones](https://jira.spring.io/secure/ViewProfile.jspa?name=jonesd9)** がコメント:

テストリポジトリを追加しました:

https://github.com/dan-j/kotlin-reactive-test-SPR-16057


### コメント 2 by spring-projects-issues

**作成日**: 2017-10-27

**[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze)** がコメント:

これは[#20251](https://github.com/spring-projects/spring-framework/issues/20251)と同様で、[KT-5464](https://youtrack.jetbrains.com/issue/KT-5464)を通じてKotlin 1.2で修正される予定でしたが、残念ながらKotlin 1.3に延期されました。JetBrainsに報告されているように、Kotlin側のこの未解決の問題により、`WebTestClient`がKotlinでまったく使用できなくなっており、現時点では非モックサーバーで`WebClient`を使用する以外の回避策を提案できません。ReactorとSpring Kotlinの拡張機能により、この[例](https://github.com/sdeleuze/spring-kotlin-deepdive/blob/248c1c89cf5a7a4293adbace296d945637ed0d20/src/test/kotlin/io/spring/deepdive/PostJsonApiTests.kt)で示されているように、かなり使いやすくなっています。

今のところ、`WebTestClient`のJavadocに警告とJetBrainsのissueへのリンクを追加し、リファレンスドキュメントをこれらの情報で更新します。Kotlin 1.3でこの問題が修正されたことが確認でき次第、このissueを解決済みとし、`WebTestClient`にはKotlin 1.3以降を使用すべきであることをドキュメントで指定します。


### コメント 3 by spring-projects-issues

**作成日**: 2018-04-17

**[Sébastien Deleuze](https://jira.spring.io/secure/ViewProfile.jspa?name=sdeleuze)** がコメント:

[#20251](https://github.com/spring-projects/spring-framework/issues/20251)が修正されました。


### コメント 4 by andriipivovarov

**作成日**: 2020-03-13

何か回避策はありますか?

### コメント 5 by noah-iam

**作成日**: 2020-06-25

こんにちは、

同様の問題について、私のコードを共有します。同じエラーが発生しています:

`.webFilter<>(myfilter)` - ここでジェネリック型を指定するように求められます。

エラー: 型が必要です

```kotlin
val client: WebTestClient = WebTestClient.bindToWebHandler { Mono.empty() }
    .webFilter<>(myfilter)
    .build()
```

エラー: 型引数が境界内にありません。期待: Nothing! 実際: WebFilter!

@sdeleuze さん、助けていただけますか?

### コメント 6 by maresja1

**作成日**: 2020-10-19

@andriipivovarov 回避策:

`MutatorFilter`クラスを再定義する必要があります(これは`SecurityMockServerConfigurers`内のprivate staticクラスです):

```kotlin
// org.springframework.security.test.web.reactive.server.SecurityMockServerConfigurers.MutatorFilterのコピー
internal class MutatorFilter : WebFilter {

    override fun filter(exchange: ServerWebExchange, webFilterChain: WebFilterChain): Mono<Void> {
        val context = exchange.getAttribute<Supplier<Mono<SecurityContext>>>(ATTRIBUTE_NAME)
        if (context != null) {
            exchange.attributes.remove(ATTRIBUTE_NAME)
            return webFilterChain.filter(exchange)
                .subscriberContext(ReactiveSecurityContextHolder.withSecurityContext(context.get()))
        }
        return webFilterChain.filter(exchange)
    }

    companion object {
        const val ATTRIBUTE_NAME = "context"
    }
}
```

そして適用:

```kotlin
WebTestClient.bindToApplicationContext(context)
    .configureClient()
    .baseUrl("https://api.example.com")
    .defaultHeader("Content-Type", MediaType.APPLICATION_JSON_VALUE)
// ...
    .apply { _, httpHandlerBuilder, _ ->
        httpHandlerBuilder?.filters { filters -> filters.add(0, MutatorFilter()) }
    }
```

より良い方法をご存知の方がいれば、教えてください。

### コメント 7 by sdeleuze

**作成日**: 2020-10-27

この問題はKotlin 1.4.10でもまだ発生しており、おそらく[KT-40804](https://youtrack.jetbrains.com/issue/KT-40804)が原因です。解決策を見つける必要があることに同意します。Kotlinチームと議論しています。

### コメント 8 by xetra11

**作成日**: 2021-02-04

何か進展はありますか?

### コメント 9 by sdeleuze

**作成日**: 2021-03-25

KotlinチームとSpringチームの両方が、この問題はKotlin側で修正されるべきだと合意しました。現在の希望は、Kotlin 1.6で修正されることです(Kotlin 1.5がもうすぐリリースされ、Kotlinは現在6ヶ月のリリースサイクルなので、そう遠くありません)。

### コメント 10 by petukhovv

**作成日**: 2021-08-03

1.5.30の実験モードで、このケースをサポートしました。1.5.30では、`-Xself-upper-bound-inference`コンパイラフラグを使用して、対応する機能を有効にできます。

詳細: https://youtrack.jetbrains.com/issue/KT-40804

### コメント 11 by sdeleuze

**作成日**: 2021-09-07

テストによると、確かに動作するようです。ありがとうございます! 適切なテストを追加するため、Kotlin 1.6ベースになった時点でこのissueをクローズします。

@petrukhnov さん、これがKotlin 1.6からデフォルトになることを確認していただけますか?

### コメント 12 by petukhovv

**作成日**: 2021-09-07

はい、1.6からデフォルトで有効になります。

### コメント 13 by sdeleuze

**作成日**: 2021-10-29

[#27413](https://github.com/spring-projects/spring-framework/issues/27413)に依存しています。
